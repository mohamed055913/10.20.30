<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظام ERP - إدارة الأصناف والتجميع والرصيد</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f4f4f4; 
      padding: 20px;
      margin: 0;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #007bff;
    }
    .tab-btn {
      padding: 12px 24px;
      background: #e9ecef;
      border: none;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      margin: 0 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: #007bff;
      color: white;
    }
    .section {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .section.active {
      display: block;
    }
    h1, h2 { 
      text-align: center; 
      color: #2c3e50;
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    .container { 
      background: #fff; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    .excel-style {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .excel-style th, .excel-style td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      min-width: 100px;
    }
    .excel-style th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .excel-style td {
      background-color: white;
      height: 30px;
    }
    .excel-style input, .excel-style select {
      width: 100%;
      border: none;
      padding: 5px;
      box-sizing: border-box;
      background: transparent;
    }
    .excel-style input:focus, .excel-style select:focus {
      outline: 2px solid #007bff;
      background: #fff;
    }
    .selected-cell {
      background-color: #e6f2ff !important;
      outline: 2px solid #007bff;
    }
    .action-btns { 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
    }
    .action-btns button { 
      padding: 4px 10px; 
      font-weight: bold; 
      border: none; 
      color: white; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .btn-add { 
      background-color: #28a745; 
    }
    .btn-remove { 
      background-color: #dc3545; 
    }
    #save-button, #cancel-button, .btn {
      margin-top: 10px; 
      padding: 10px 20px; 
      font-size: 16px; 
      margin-left: 10px;
      border: none; 
      border-radius: 5px; 
      cursor: pointer;
      color: white;
      transition: background 0.3s;
    }
    #save-button, .btn-primary {
      background-color: #007bff;
    }
    #save-button:hover, .btn-primary:hover {
      background-color: #0069d9;
    }
    #cancel-button, .btn-secondary {
      background-color: #6c757d;
    }
    #cancel-button:hover, .btn-secondary:hover {
      background-color: #5a6268;
    }
    .btn-success {
      background-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
    }
    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    .btn-warning:hover {
      background-color: #e0a800;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .btn-info {
      background-color: #17a2b8;
    }
    .btn-info:hover {
      background-color: #138496;
    }
    .product-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #495057;
    }
    .auto-code {
      background-color: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
      color: #495057;
      text-align: center;
    }
    .search-box {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .search-box input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .search-box button {
      padding: 10px 20px;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .info-box {
      background: #e7f3fe;
      border-left: 4px solid #2196F3;
      padding: 12px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .highlight {
      background-color: #fff9c4;
      transition: background-color 0.5s;
    }
    .code-input {
      background-color: #e9ecef;
      font-weight: bold;
      text-align: center;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    .total-row {
      background-color: #f8f9fa !important;
      font-weight: bold;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .report-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .report-card h3 {
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-top: 0;
    }
    .form-control {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .admin-only {
      display: none;
    }
    #data-section table {
      min-width: 100%;
    }
    #data-section .info-box {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    #data-search {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-left: 10px;
    }
    .draft-notice {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      text-align: center;
      border-left: 4px solid #ffeeba;
    }
    .code-box {
      background-color: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
    }
    .read-only-cell {
      background-color: #f8f9fa !important;
      font-weight: bold;
      text-align: center;
    }
    /* أنماط شاشة الرصيد */
    #inventory-section input[type="number"] {
      text-align: center;
      padding: 5px;
    }
    #inventory-section .form-control {
      width: auto;
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- قسم تسجيل الدخول -->
  <div id="login-section" style="max-width: 400px; margin: 50px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
    <h1 style="text-align: center;">تسجيل الدخول</h1>
    <div class="form-group">
      <label>اسم المستخدم</label>
      <input type="text" id="login-username" class="form-control">
    </div>
    <div class="form-group">
      <label>كلمة المرور</label>
      <input type="password" id="login-password" class="form-control">
    </div>
    <button onclick="login()" class="btn btn-primary" style="width: 100%;">دخول</button>
  </div>

  <div id="main-sections" style="display: none;">
    <!-- شريط معلومات المستخدم -->
    <div style="text-align: left; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
      <span id="user-info"></span>
      <button onclick="logout()" class="btn btn-danger" style="float: left;">تسجيل الخروج</button>
    </div>

    <!-- تبويبات النظام -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showSection('assembly-section')">شاشة التجميع</button>
      <button class="tab-btn" onclick="showSection('products-section')">شاشة الأصناف</button>
      <button class="tab-btn" onclick="showSection('inventory-section')">شاشة الرصيد</button>
      <button class="tab-btn" onclick="showSection('groups-section')">شاشة المجموعات</button>
      <button class="tab-btn" onclick="showSection('lines-section')">شاشة الخطوط</button>
      <button class="tab-btn" onclick="showSection('daily-register-section')">التسجيل اليومي</button>
      <button class="tab-btn" onclick="showSection('daily-data-section'); loadDailyData()">بيانات التسجيل</button>
      <button class="tab-btn" onclick="showSection('data-section'); loadSavedData()">عرض البيانات</button>
      <button class="tab-btn" onclick="showSection('reports-section'); generateReports()">التقارير</button>
      <button class="tab-btn" onclick="showSection('supervisors-section')">المشرفين</button>
      <button class="tab-btn" onclick="showSection('fixedcodes-section')">الأكواد الثابتة</button>
    </div>

    <!-- شاشة التجميع -->
    <div id="assembly-section" class="section active">
      <div class="container">
        <h1>نظام ERP لتسجيل التجميع</h1>
        
        <div class="draft-notice">
          <strong>ملاحظة:</strong> هذه البيانات مؤقتة حتى تقوم بالحفظ. سيتم مسحها تلقائيًا عند الانتقال لشاشة أخرى.
        </div>
        
        <div class="toolbar">
          <button class="btn btn-success" onclick="addNewRow()">➕ صف جديد</button>
          <button class="btn btn-danger" onclick="deleteSelectedRow()">🗑️ حذف الصف</button>
          <button id="save-assembly-btn" class="btn btn-primary" onclick="saveAssemblyData()">💾 حفظ التجميع</button>
          <div id="save-message" class="success-message"></div>
        </div>
        
        <div id="excel-container">
          <table class="excel-style" id="excel-table">
            <thead>
              <tr id="header-row"></tr>
            </thead>
            <tbody id="data-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- شاشة الأصناف -->
    <div id="products-section" class="section">
      <div class="container">
        <h1>إدارة الأصناف</h1>
        
        <div class="product-form">
          <h2 id="form-title">إضافة صنف جديد</h2>
          <div class="form-group">
            <label>كود الصنف <span id="code-status">(تلقائي)</span></label>
            <div class="auto-code" id="auto-code">يتم توليده تلقائياً</div>
          </div>
          <div class="form-group">
            <label>اسم الصنف</label>
            <input type="text" id="product-name" placeholder="أدخل اسم الصنف" class="form-control">
          </div>
          <div class="form-group">
            <label>المجموعة</label>
            <select id="product-group" class="form-control">
              <option value="">اختر مجموعة...</option>
            </select>
          </div>
          <div class="form-group">
            <label>نوع الغطاء</label>
            <input type="text" id="cover-type" placeholder="أدخل نوع الغطاء" class="form-control">
          </div>
          <div class="form-group">
            <label>نوع العلبة</label>
            <input type="text" id="box-type" placeholder="أدخل نوع العلبة" class="form-control">
          </div>
          <div class="form-group">
            <label>لون العلبة</label>
            <input type="text" id="box-color" placeholder="أدخل لون العلبة" class="form-control">
          </div>
          <div class="form-group">
            <label>لون الغطاء</label>
            <input type="text" id="cover-color" placeholder="أدخل لون الغطاء" class="form-control">
          </div>
          <div class="form-group">
            <label>الاتجاه</label>
            <select id="direction" class="form-control">
              <option value="">اختر الاتجاه</option>
              <option value="L">L</option>
              <option value="R">R</option>
            </select>
          </div>
          <div class="form-group">
            <label>˖ (القيمة الموجبة)</label>
            <input type="number" step="0.01" id="product-plus" placeholder="أدخل قيمة ˖" class="form-control">
          </div>
          <div class="form-group">
            <label>˗ (القيمة السالبة)</label>
            <input type="number" step="0.01" id="product-minus" placeholder="أدخل قيمة ˗" class="form-control">
          </div>
          <div class="form-group">
            <label>ملاحظات</label>
            <input type="text" id="product-notes" placeholder="أدخل أي ملاحظات" class="form-control">
          </div>
          <div class="form-group">
            <label>كود العلب</label>
            <input type="text" id="box-code" placeholder="أدخل كود العلب" class="form-control">
          </div>
          <div class="form-group">
            <label>كود الغطاء</label>
            <input type="text" id="cover-code" placeholder="أدخل كود الغطاء" class="form-control">
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="product-action-btn" onclick="addProduct()">➕ إضافة صنف</button>
            <button class="btn btn-secondary" id="cancel-edit-btn" style="display:none;" onclick="cancelEdit()">❌ إلغاء التعديل</button>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="product-search" placeholder="ابحث باسم الصنف أو الكود..." class="form-control">
          <button class="btn btn-primary" onclick="searchProducts()">🔍 بحث</button>
        </div>

        <table id="products-table" class="excel-style">
          <thead>
            <tr>
              <th>كود الصنف</th>
              <th>اسم الصنف</th>
              <th>المجموعة</th>
              <th>نوع الغطاء</th>
              <th>نوع العلبة</th>
              <th>لون العلبة</th>
              <th>لون الغطاء</th>
              <th>الاتجاه</th>
              <th>˖</th>
              <th>˗</th>
              <th>ملاحظات</th>
              <th>كود العلب</th>
              <th>كود الغطاء</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="products-list"></tbody>
        </table>
      </div>
    </div>

    <!-- شاشة الرصيد -->
    <div id="inventory-section" class="section">
      <div class="container">
        <h1>إدارة رصيد الأصناف</h1>
        
        <div class="info-box">
          <strong>ملاحظة:</strong> يتم تحديث الرصيد تلقائياً عند إضافة أصناف جديدة. يمكنك تعديل الكميات يدوياً عند الحاجة.
        </div>
        
        <div class="search-box">
          <input type="text" id="inventory-search" placeholder="ابحث باسم الصنف أو الكود..." class="form-control">
          <button class="btn btn-primary" onclick="searchInventory()">🔍 بحث</button>
          <button class="btn btn-success" onclick="updateAllInventory()">🔄 تحديث الكل</button>
        </div>
        
        <table id="inventory-table" class="excel-style">
          <thead>
            <tr>
              <th>كود الصنف</th>
              <th>المجموعة</th>
              <th>اسم الصنف</th>
              <th>التكوين +</th>
              <th>التكوين -</th>
              <th>لون العلبة</th>
              <th>لون الغطا</th>
              <th>نوع العلبة</th>
              <th>نوع الغطا</th>
              <th>الاتجاة</th>
              <th>الرصيد الحالي</th>
              <th>آخر تحديث</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="inventory-list"></tbody>
        </table>
      </div>
    </div>

    <!-- شاشة المجموعات -->
    <div id="groups-section" class="section">
      <div class="container">
        <h1>إدارة المجموعات</h1>
        
        <div class="product-form">
          <h2 id="group-form-title">إضافة مجموعة جديدة</h2>
          <div class="form-group">
            <label>اسم المجموعة</label>
            <input type="text" id="group-name" placeholder="أدخل اسم المجموعة" class="form-control">
          </div>
          <div class="form-group">
            <label>ملاحظات</label>
            <input type="text" id="group-notes" placeholder="أدخل أي ملاحظات" class="form-control">
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="group-action-btn" onclick="addGroup()">➕ إضافة مجموعة</button>
            <button class="btn btn-secondary" id="cancel-group-edit-btn" style="display:none;" onclick="cancelGroupEdit()">❌ إلغاء التعديل</button>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="group-search" placeholder="ابحث باسم المجموعة..." class="form-control">
          <button class="btn btn-primary" onclick="searchGroups()">🔍 بحث</button>
        </div>

        <table id="groups-table" class="excel-style">
          <thead>
            <tr>
              <th>اسم المجموعة</th>
              <th>عدد الأصناف</th>
              <th>ملاحظات</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="groups-list"></tbody>
        </table>
      </div>
    </div>

    <!-- شاشة الخطوط -->
    <div id="lines-section" class="section">
      <div class="container">
        <h1>إدارة الخطوط</h1>
        
        <div class="product-form">
          <h2 id="line-form-title">إضافة خط جديد</h2>
          <div class="form-group">
            <label>رقم الخط</label>
            <input type="text" id="line-number" placeholder="أدخل رقم الخط" class="form-control">
          </div>
          <div class="form-group">
            <label>اسم الخط</label>
            <input type="text" id="line-name" placeholder="أدخل اسم الخط" class="form-control">
          </div>
          <div class="form-group">
            <label>الموقع</label>
            <input type="text" id="line-location" placeholder="أدخل موقع الخط" class="form-control">
          </div>
          <div class="form-group">
            <label>ملاحظات</label>
            <input type="text" id="line-notes" placeholder="أدخل أي ملاحظات" class="form-control">
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="line-action-btn" onclick="addLine()">➕ إضافة خط</button>
            <button class="btn btn-secondary" id="cancel-line-edit-btn" style="display:none;" onclick="cancelLineEdit()">❌ إلغاء التعديل</button>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="line-search" placeholder="ابحث برقم الخط أو اسمه..." class="form-control">
          <button class="btn btn-primary" onclick="searchLines()">🔍 بحث</button>
        </div>

        <table id="lines-table" class="excel-style">
          <thead>
            <tr>
              <th>رقم الخط</th>
              <th>اسم الخط</th>
              <th>الموقع</th>
              <th>ملاحظات</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="lines-list"></tbody>
        </table>
      </div>
    </div>

    <!-- شاشة التسجيل اليومي -->
    <div id="daily-register-section" class="section">
      <div class="container">
        <h1>التسجيل اليومي</h1>
        
        <div class="draft-notice">
          <strong>ملاحظة:</strong> يتم تحديث الرصيد تلقائياً عند حفظ البيانات.
        </div>
        
        <div class="toolbar">
          <button class="btn btn-success" onclick="addNewDailyRow()">➕ صف جديد</button>
          <button class="btn btn-danger" onclick="deleteSelectedDailyRow()">🗑️ حذف الصف</button>
          <button id="save-daily-btn" class="btn btn-primary" onclick="saveDailyData()">💾 حفظ البيانات</button>
          <div id="daily-save-message" class="success-message"></div>
        </div>
        
        <div id="daily-excel-container">
          <table class="excel-style" id="daily-excel-table">
            <thead>
              <tr id="daily-header-row"></tr>
            </thead>
            <tbody id="daily-data-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- شاشة بيانات التسجيل اليومي -->
    <div id="daily-data-section" class="section">
      <div class="container">
        <h1>بيانات التسجيل اليومي</h1>
        
        <div class="info-box">
          <strong>ملاحظة:</strong> يمكنك تصدير البيانات أو البحث فيها.
        </div>
        
        <div class="toolbar">
          <input type="text" id="daily-data-search" placeholder="ابحث في البيانات..." style="flex:1">
          <button class="btn btn-primary" onclick="filterDailyData()">🔍 بحث</button>
          <button class="btn btn-secondary" onclick="exportDailyData()">📤 تصدير الكل</button>
          <button class="btn btn-info" onclick="loadDailyData()">🔄 تحديث</button>
        </div>
        
        <div class="info-box">
          <strong>عدد السجلات:</strong> <span id="daily-data-count">0</span> | 
          <strong>آخر تحديث:</strong> <span id="daily-last-update">غير معروف</span>
        </div>
        
        <div style="overflow-x: auto; max-height: 500px;">
          <table class="excel-style" id="saved-daily-table">
            <thead>
              <tr id="daily-data-header"></tr>
            </thead>
            <tbody id="saved-daily-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- قسم عرض البيانات -->
    <div id="data-section" class="section">
      <div class="container">
        <h1>البيانات المحفوظة</h1>
        
        <div class="info-box">
          <strong>ملاحظة:</strong> يمكنك التعديل أو الحذف مباشرة من هنا. عند التعديل سيتم نقل السجل إلى شاشة التجميع.
        </div>
        
        <div class="toolbar">
          <input type="text" id="data-search" placeholder="ابحث في البيانات..." style="flex:1">
          <button class="btn btn-primary" onclick="filterData()">🔍 بحث</button>
          <button class="btn btn-secondary" onclick="exportAllData()">📤 تصدير الكل</button>
          <button class="btn btn-info" onclick="loadSavedData()">🔄 تحديث</button>
        </div>
        
        <div class="info-box">
          <strong>عدد السجلات:</strong> <span id="data-count">0</span> | 
          <strong>آخر تحديث:</strong> <span id="last-update">غير معروف</span>
        </div>
        
        <div style="overflow-x: auto; max-height: 500px;">
          <table class="excel-style" id="saved-data-table">
            <thead>
              <tr id="data-header"></tr>
            </thead>
            <tbody id="saved-data-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- شاشة المشرفين -->
    <div id="supervisors-section" class="section">
      <div class="container">
        <h1>إدارة أسماء مشرفي الخطوط</h1>
        <div class="product-form">
          <div class="form-group">
            <label>اسم المشرف</label>
            <input type="text" id="supervisor-name-input" class="form-control" placeholder="مثال: محمد أحمد">
          </div>
          <button class="btn btn-success" onclick="addSupervisor()">➕ إضافة مشرف</button>
        </div>
        <table class="excel-style">
          <thead><tr><th>اسم المشرف</th><th>الإجراءات</th></tr></thead>
          <tbody id="supervisors-list"></tbody>
        </table>
      </div>
    </div>

    <!-- شاشة الأكواد الثابتة -->
    <div id="fixedcodes-section" class="section">
      <div class="container">
        <h1>إدارة الأكواد الثابتة</h1>
        <div class="product-form">
          <div class="form-group">
            <label>أدخل كود جديد</label>
            <input type="text" id="fixed-code-input" class="form-control" placeholder="مثال: FC-005">
          </div>
          <button class="btn btn-success" onclick="addFixedCode()">➕ إضافة الكود</button>
        </div>
        <table class="excel-style">
          <thead>
            <tr><th>الكود</th><th>الإجراءات</th></tr>
          </thead>
          <tbody id="fixed-codes-list"></tbody>
        </table>
      </div>
    </div>

    <!-- قسم التقارير -->
    <div id="reports-section" class="section">
      <div class="container">
        <h1>التقارير والإحصائيات</h1>
        <div class="toolbar">
          <button class="btn btn-primary" onclick="generateReports()">🔄 تحديث التقارير</button>
          <button class="btn btn-success" onclick="exportReports()">📊 تصدير التقارير</button>
        </div>
        
        <div id="reports-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
          <!-- سيتم ملؤه ديناميكياً -->
        </div>

        <div class="toolbar" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px;">
          <button class="btn btn-warning" onclick="backupData()" style="color: #212529;">💾 إنشاء نسخة احتياطية</button>
          <label for="restore-file" class="btn btn-danger" style="margin: 0;">
            🔄 استعادة نسخة احتياطية
          </label>
          <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreData(event)">
        </div>
      </div>
    </div>
  </div>

<script>
// البيانات العامة
const fixedCodes = ["FC-001", "FC-002", "FC-003", "FC-004"];
const fieldNames = [
  "التاريخ","الاسبوع","الودية","رقم الخط","رقم الازن","كود","المجموعة","اسم الصنف","˖","˗",
  "نوع الغطاء","نوع العلبة","لون العلبة","لون الغطا","الاتجاة","الإنتاجية","ختم البطارية","نوع البلكات المستخدمه",
  "ملاحظات بلكات","البلكات المصروفة (+)","البلكات المصروفة (-)","البلكات المستخدمه (+)","البلكات المستخدمه (-)",
  "الغطاء 1(المستخدم)","العلبة (المستخدم)","البلكات (الهالك)","هالك خرده+","هالك خرده -","هالك تفوير+","هالك تفوير-",
  "خلايا تحت التفوير","بطاريات تحت التفوير","هالك العازل (عدد)",
  "الغطاء 1(الهالك)","دمية غطا","عيب تخويش","تسييح غطا","عيب وارد غطا","تفوير غطاء",
  "العلبة (الهالك)","دمية علب","عيب وارد علب","ريجه","عيب تخريم","كبسنه","تسييح علب","تفوير علب",
  "مراقب الانتاج","مشرف الخط","كود العلب","كود الغطا",
  "العلب المصروفة",
  "الغطا المصروف",
  "الكود ثابت"
];

// تهيئة التخزين المحلي
let entries = JSON.parse(localStorage.getItem("batteryData") || "[]");
let tempEntries = []; // بيانات مؤقتة قبل الحفظ
let products = JSON.parse(localStorage.getItem("products") || "[]");
let groups = JSON.parse(localStorage.getItem("groups") || "[]");
let lines = JSON.parse(localStorage.getItem("lines") || "[]");
let inventory = JSON.parse(localStorage.getItem("inventory") || "[]");
let currentProductId = 2000000;
let editingProductId = null;
let editingGroupId = null;
let editingLineId = null;
let selectedCell = null;
let selectedRowIndex = -1;
let isEditingMode = false;
let editingIndex = -1;

// متغيرات التسجيل اليومي
let dailyEntries = JSON.parse(localStorage.getItem("dailyData") || "[]");
let tempDailyEntries = [];
const dailyFieldNames = [
  "التاريخ", "الوردية", "رقم الخط", "رقم الازن", "نوع العملية",
  "كود الصنف", "المجموعة", "اسم الصنف", "التكوين +", "التكوين -",
  "نوع الغطا", "نوع العلبة", "لون العلبة", "لون الغطا", "الاتجاة",
  "الكمية"
];
let selectedDailyCell = null;
let selectedDailyRowIndex = -1;

// ===== نظام المصادقة =====
const users = JSON.parse(localStorage.getItem('erpUsers') || '[]');
let currentUser = null;

// إذا لم يكن هناك مستخدمين، نضيف مستخدم افتراضي
if (users.length === 0) {
  users.push({
    id: 1,
    username: 'admin',
    password: 'admin123',
    name: 'المدير العام',
    role: 'admin'
  });
  localStorage.setItem('erpUsers', JSON.stringify(users));
}

function showLoginForm() {
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('main-sections').style.display = 'none';
  document.getElementById('login-username').focus();
}

function login() {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    currentUser = user;
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-sections').style.display = 'block';
    document.getElementById('user-info').textContent = `مرحباً ${user.name}`;
    initPage();
  } else {
    alert('اسم المستخدم أو كلمة المرور غير صحيحة');
  }
}

function logout() {
  currentUser = null;
  showLoginForm();
}

// ===== دوال شاشة التجميع =====
function createExcelTable() {
  const headerRow = document.getElementById("header-row");
  headerRow.innerHTML = "";
  
  fieldNames.forEach(field => {
    const th = document.createElement("th");
    th.textContent = field;
    headerRow.appendChild(th);
  });
  
  loadDataIntoTable();
  
  if (tempEntries.length === 0) {
    addNewRow();
  }
}

function loadDataIntoTable() {
  const tbody = document.getElementById("data-body");
  tbody.innerHTML = "";
  
  tempEntries.forEach((entry, rowIndex) => {
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = rowIndex;
    
    fieldNames.forEach((field, colIndex) => {
      const td = document.createElement("td");
      td.dataset.field = field;
      
      if (field === "التاريخ") {
        const input = document.createElement("input");
        input.type = "date";
        input.value = entry[field] || new Date().toISOString().split('T')[0];
        input.addEventListener("change", () => updateCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else if (field === "الودية") {
        const select = document.createElement("select");
        ["1", "2", "3"].forEach(num => {
          const option = document.createElement("option");
          option.value = num;
          option.textContent = num;
          select.appendChild(option);
        });
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "كود") {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.className = "code-input";
        input.addEventListener("blur", function() {
          const productId = this.value.trim();
          if (!productId) return;
          
          const product = products.find(p => p.id == productId);
          if (product) {
            fillProductData(tr, product);
          }
        });
        input.addEventListener("change", () => updateCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.addEventListener("change", () => updateCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      
      td.addEventListener("click", function() {
        selectCell(this, rowIndex);
      });
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

function fillProductData(row, product) {
  const fieldsToFill = {
    "المجموعة": product.group || '',
    "اسم الصنف": product.name,
    "˖": product.plus || '',
    "˗": product.minus || '',
    "نوع الغطاء": product.coverType || '',
    "نوع العلبة": product.boxType || '',
    "لون العلبة": product.boxColor || '',
    "لون الغطا": product.coverColor || '',
    "الاتجاة": product.direction || '',
    "كود العلب": product.boxCode || '',
    "كود الغطا": product.coverCode || ''
  };
  
  Object.entries(fieldsToFill).forEach(([field, value]) => {
    const input = row.querySelector(`[data-field="${field}"] input`);
    if (input) {
      input.value = value;
      updateCellValue(row.dataset.rowIndex, field, value);
    }
  });
}

function updateCellValue(rowIndex, field, value) {
  if (!tempEntries[rowIndex]) tempEntries[rowIndex] = {};
  tempEntries[rowIndex][field] = value;
}

function addNewRow() {
  const newRow = {};
  newRow["التاريخ"] = new Date().toISOString().split('T')[0];
  tempEntries.push(newRow);
  loadDataIntoTable();
  
  const newRowIndex = tempEntries.length - 1;
  const newRowElement = document.querySelector(`#data-body tr[data-row-index="${newRowIndex}"]`);
  if (newRowElement) {
    const firstInput = newRowElement.querySelector("td:first-child input");
    if (firstInput) firstInput.focus();
  }
}

function deleteRow(rowIndex) {
  tempEntries.splice(rowIndex, 1);
  loadDataIntoTable();
}

function deleteSelectedRow() {
  if (selectedRowIndex >= 0) {
    deleteRow(selectedRowIndex);
  } else {
    alert("الرجاء تحديد صف لحذفه");
  }
}

function saveAssemblyData() {
  if (tempEntries.length === 0) {
    alert("لا توجد بيانات للحفظ");
    return;
  }
  
  entries = [...entries, ...tempEntries];
  localStorage.setItem("batteryData", JSON.stringify(entries));
  localStorage.setItem("lastUpdate", new Date().toLocaleString("ar-EG"));
  
  tempEntries = [];
  loadDataIntoTable();
  
  const messageEl = document.getElementById('save-message');
  messageEl.textContent = `تم حفظ ${entries.length} سجل بنجاح`;
  messageEl.style.display = 'block';
  setTimeout(() => messageEl.style.display = 'none', 3000);
}

function selectCell(cell, rowIndex) {
  if (selectedCell) {
    selectedCell.classList.remove("selected-cell");
  }
  selectedCell = cell;
  selectedRowIndex = rowIndex;
  cell.classList.add("selected-cell");
  
  const input = cell.querySelector("input, select");
  if (input) input.focus();
}

// ===== دوال شاشة التسجيل اليومي =====
function createDailyTable() {
  const headerRow = document.getElementById("daily-header-row");
  headerRow.innerHTML = "";
  
  dailyFieldNames.forEach(field => {
    const th = document.createElement("th");
    th.textContent = field;
    headerRow.appendChild(th);
  });
  
  loadDailyDataIntoTable();
  
  if (tempDailyEntries.length === 0) {
    addNewDailyRow();
  }
}

function loadDailyDataIntoTable() {
  const tbody = document.getElementById("daily-data-body");
  tbody.innerHTML = "";
  
  tempDailyEntries.forEach((entry, rowIndex) => {
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = rowIndex;
    
    dailyFieldNames.forEach((field, colIndex) => {
      const td = document.createElement("td");
      td.dataset.field = field;
      
      if (field === "التاريخ") {
        const input = document.createElement("input");
        input.type = "date";
        input.value = entry[field] || new Date().toISOString().split('T')[0];
        input.addEventListener("change", () => updateDailyCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else if (field === "الوردية") {
        const select = document.createElement("select");
        ["1", "2", "3"].forEach(num => {
          const option = document.createElement("option");
          option.value = num;
          option.textContent = num;
          select.appendChild(option);
        });
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateDailyCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "رقم الخط") {
        const select = document.createElement("select");
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = "اختر خطاً...";
        select.appendChild(emptyOption);
        
        lines.forEach(line => {
          const option = document.createElement("option");
          option.value = line.number;
          option.textContent = `${line.number} - ${line.name || 'بدون اسم'}`;
          select.appendChild(option);
        });
        
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateDailyCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "نوع العملية") {
        const select = document.createElement("select");
        ["إضافة", "صرف", "ارتجاع", "تحويل"].forEach(type => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          select.appendChild(option);
        });
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateDailyCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "كود الصنف") {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.className = "code-input";
        input.addEventListener("blur", function() {
          const productId = this.value.trim();
          if (!productId) return;
          
          const product = products.find(p => p.id == productId);
          if (product) {
            fillDailyProductData(tr, product);
          }
        });
        input.addEventListener("change", () => updateDailyCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else if (field === "الكمية") {
        const input = document.createElement("input");
        input.type = "number";
        input.value = entry[field] || "";
        input.addEventListener("change", () => updateDailyCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.readOnly = true;
        input.className = "read-only-cell";
        td.appendChild(input);
      }
      
      td.addEventListener("click", function() {
        selectDailyCell(this, rowIndex);
      });
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

function fillDailyProductData(row, product) {
  const fieldsToFill = {
    "المجموعة": product.group || '',
    "اسم الصنف": product.name,
    "التكوين +": product.plus || '',
    "التكوين -": product.minus || '',
    "نوع الغطا": product.coverType || '',
    "نوع العلبة": product.boxType || '',
    "لون العلبة": product.boxColor || '',
    "لون الغطا": product.coverColor || '',
    "الاتجاة": product.direction || ''
  };
  
  Object.entries(fieldsToFill).forEach(([field, value]) => {
    const input = row.querySelector(`[data-field="${field}"] input`);
    if (input) {
      input.value = value;
      updateDailyCellValue(row.dataset.rowIndex, field, value);
    }
  });
}

function updateDailyCellValue(rowIndex, field, value) {
  if (!tempDailyEntries[rowIndex]) tempDailyEntries[rowIndex] = {};
  tempDailyEntries[rowIndex][field] = value;
}

function addNewDailyRow() {
  const newRow = {};
  newRow["التاريخ"] = new Date().toISOString().split('T')[0];
  tempDailyEntries.push(newRow);
  loadDailyDataIntoTable();
  
  const newRowIndex = tempDailyEntries.length - 1;
  const newRowElement = document.querySelector(`#daily-data-body tr[data-row-index="${newRowIndex}"]`);
  if (newRowElement) {
    const firstInput = newRowElement.querySelector("td:first-child input");
    if (firstInput) firstInput.focus();
  }
}

function deleteDailyRow(rowIndex) {
  tempDailyEntries.splice(rowIndex, 1);
  loadDailyDataIntoTable();
}

function deleteSelectedDailyRow() {
  if (selectedDailyRowIndex >= 0) {
    deleteDailyRow(selectedDailyRowIndex);
  } else {
    alert("الرجاء تحديد صف لحذفه");
  }
}

function saveDailyData() {
  if (tempDailyEntries.length === 0) {
    alert("لا توجد بيانات للحفظ");
    return;
  }
  
  // تحديث المخزون بناء على نوع العملية
  tempDailyEntries.forEach(entry => {
    const productId = entry["كود الصنف"];
    const quantity = parseFloat(entry["الكمية"]) || 0;
    const operation = entry["نوع العملية"];
    
    if (!productId) return;
    
    const inventoryItem = inventory.find(item => item.productId == productId);
    if (!inventoryItem) return;
    
    switch(operation) {
      case "إضافة":
        inventoryItem.quantity += quantity;
        break;
      case "صرف":
        inventoryItem.quantity -= quantity;
        break;
      case "ارتجاع":
        inventoryItem.quantity += quantity;
        break;
      case "تحويل":
        // يمكن إضافة منطق خاص بالتحويل إذا لزم الأمر
        break;
    }
    
    inventoryItem.lastUpdated = new Date().toLocaleString("ar-EG");
  });
  
  // حفظ البيانات
  dailyEntries = [...dailyEntries, ...tempDailyEntries];
  localStorage.setItem("dailyData", JSON.stringify(dailyEntries));
  localStorage.setItem("inventory", JSON.stringify(inventory));
  localStorage.setItem("dailyLastUpdate", new Date().toLocaleString("ar-EG"));
  
  // إفراغ البيانات المؤقتة
  tempDailyEntries = [];
  loadDailyDataIntoTable();
  
  // عرض رسالة تأكيد
  const messageEl = document.getElementById('daily-save-message');
  messageEl.textContent = `تم حفظ ${dailyEntries.length} سجل بنجاح`;
  messageEl.style.display = 'block';
  setTimeout(() => messageEl.style.display = 'none', 3000);
  
  // تحديث شاشة الرصيد
  renderInventoryTable();
}

function loadDailyData() {
  dailyEntries = JSON.parse(localStorage.getItem("dailyData") || "[]");
  const headerRow = document.getElementById("daily-data-header");
  const dataBody = document.getElementById("saved-daily-body");
  
  document.getElementById("daily-data-count").textContent = dailyEntries.length;
  document.getElementById("daily-last-update").textContent = 
    localStorage.getItem("dailyLastUpdate") || "غير معروف";
  
  headerRow.innerHTML = "";
  if (dailyEntries.length > 0) {
    dailyFieldNames.forEach(field => {
      const th = document.createElement("th");
      th.textContent = field;
      headerRow.appendChild(th);
    });
    
    const actionTh = document.createElement("th");
    actionTh.textContent = "الإجراءات";
    headerRow.appendChild(actionTh);
  }
  
  dataBody.innerHTML = "";
  dailyEntries.forEach((entry, index) => {
    const tr = document.createElement("tr");
    tr.dataset.index = index;
    
    dailyFieldNames.forEach(field => {
      const td = document.createElement("td");
      td.textContent = entry[field] || "-";
      tr.appendChild(td);
    });
    
    const actionTd = document.createElement("td");
    actionTd.innerHTML = `
      <button class="btn btn-danger" onclick="deleteDailyEntry(${index})">🗑️ حذف</button>
    `;
    tr.appendChild(actionTd);
    
    dataBody.appendChild(tr);
  });
}

function deleteDailyEntry(index) {
  if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
    dailyEntries.splice(index, 1);
    localStorage.setItem("dailyData", JSON.stringify(dailyEntries));
    loadDailyData();
  }
}

function exportDailyData() {
  if (dailyEntries.length === 0) {
    alert("لا توجد بيانات محفوظة للتصدير");
    return;
  }
  
  const csvContent = [
    dailyFieldNames.join(","),
    ...dailyEntries.map(item => dailyFieldNames.map(field => item[field] || "").join(","))
  ].join("\n");
  
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `بيانات_التسجيل_اليومي_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
}

function filterDailyData() {
  const searchTerm = document.getElementById("daily-data-search").value.toLowerCase();
  const rows = document.querySelectorAll("#saved-daily-body tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

function selectDailyCell(cell, rowIndex) {
  if (selectedDailyCell) {
    selectedDailyCell.classList.remove("selected-cell");
  }
  selectedDailyCell = cell;
  selectedDailyRowIndex = rowIndex;
  cell.classList.add("selected-cell");
  
  const input = cell.querySelector("input, select");
  if (input) input.focus();
}

// ===== دوال شاشة الأصناف =====
function updateAutoCode() {
  currentProductId = products.length > 0 ? 
    Math.max(...products.map(p => parseInt(p.id))) + 1 : 
    2000000;
  document.getElementById("auto-code").textContent = currentProductId;
}

function addProduct() {
  const name = document.getElementById("product-name").value.trim();
  const group = document.getElementById("product-group").value;
  
  if (!name || !group) {
    alert("الرجاء إدخال اسم الصنف واختيار مجموعة");
    return;
  }
  
  const product = {
    id: editingProductId || currentProductId.toString(),
    name,
    group,
    coverType: document.getElementById("cover-type").value,
    boxType: document.getElementById("box-type").value,
    boxColor: document.getElementById("box-color").value,
    coverColor: document.getElementById("cover-color").value,
    direction: document.getElementById("direction").value,
    plus: document.getElementById("product-plus").value,
    minus: document.getElementById("product-minus").value,
    notes: document.getElementById("product-notes").value,
    boxCode: document.getElementById("box-code").value,
    coverCode: document.getElementById("cover-code").value
  };
  
  if (editingProductId) {
    // تحديث الصنف الموجود
    const index = products.findIndex(p => p.id == editingProductId);
    if (index !== -1) {
      products[index] = product;
    }
    editingProductId = null;
    document.getElementById("product-action-btn").textContent = "➕ إضافة صنف";
    document.getElementById("cancel-edit-btn").style.display = "none";
    document.getElementById("form-title").textContent = "إضافة صنف جديد";
  } else {
    // إضافة صنف جديد
    products.push(product);
    
    // إضافة إلى المخزون
    inventory.push({
      productId: product.id,
      productName: product.name,
      group: product.group,
      quantity: 0,
      lastUpdated: new Date().toLocaleString("ar-EG"),
      plus: product.plus,
      minus: product.minus,
      boxColor: product.boxColor,
      coverColor: product.coverColor,
      boxType: product.boxType,
      coverType: product.coverType,
      direction: product.direction
    });
    
    currentProductId++;
  }
  
  localStorage.setItem("products", JSON.stringify(products));
  localStorage.setItem("inventory", JSON.stringify(inventory));
  renderProductsTable();
  renderInventoryTable();
  updateAutoCode();
  resetProductForm();
}

function editProduct(productId) {
  const product = products.find(p => p.id == productId);
  if (!product) return;
  
  editingProductId = productId;
  document.getElementById("product-name").value = product.name;
  document.getElementById("product-group").value = product.group;
  document.getElementById("cover-type").value = product.coverType || "";
  document.getElementById("box-type").value = product.boxType || "";
  document.getElementById("box-color").value = product.boxColor || "";
  document.getElementById("cover-color").value = product.coverColor || "";
  document.getElementById("direction").value = product.direction || "";
  document.getElementById("product-plus").value = product.plus || "";
  document.getElementById("product-minus").value = product.minus || "";
  document.getElementById("product-notes").value = product.notes || "";
  document.getElementById("box-code").value = product.boxCode || "";
  document.getElementById("cover-code").value = product.coverCode || "";
  
  document.getElementById("auto-code").textContent = productId;
  document.getElementById("product-action-btn").textContent = "💾 حفظ التعديلات";
  document.getElementById("cancel-edit-btn").style.display = "inline-block";
  document.getElementById("form-title").textContent = "تعديل صنف";
}

function deleteProduct(productId) {
  if (confirm("هل أنت متأكد من حذف هذا الصنف؟")) {
    products = products.filter(p => p.id != productId);
    inventory = inventory.filter(i => i.productId != productId);
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("inventory", JSON.stringify(inventory));
    renderProductsTable();
    renderInventoryTable();
    updateAutoCode();
  }
}

function resetProductForm() {
  document.getElementById("product-name").value = "";
  document.getElementById("product-group").value = "";
  document.getElementById("cover-type").value = "";
  document.getElementById("box-type").value = "";
  document.getElementById("box-color").value = "";
  document.getElementById("cover-color").value = "";
  document.getElementById("direction").value = "";
  document.getElementById("product-plus").value = "";
  document.getElementById("product-minus").value = "";
  document.getElementById("product-notes").value = "";
  document.getElementById("box-code").value = "";
  document.getElementById("cover-code").value = "";
  updateAutoCode();
}

function cancelEdit() {
  editingProductId = null;
  document.getElementById("product-action-btn").textContent = "➕ إضافة صنف";
  document.getElementById("cancel-edit-btn").style.display = "none";
  document.getElementById("form-title").textContent = "إضافة صنف جديد";
  resetProductForm();
}

function renderProductsTable() {
  const tbody = document.getElementById("products-list");
  tbody.innerHTML = "";
  
  products.forEach(product => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${product.id}</td>
      <td>${product.name}</td>
      <td>${product.group}</td>
      <td>${product.coverType || '-'}</td>
      <td>${product.boxType || '-'}</td>
      <td>${product.boxColor || '-'}</td>
      <td>${product.coverColor || '-'}</td>
      <td>${product.direction || '-'}</td>
      <td>${product.plus || '-'}</td>
      <td>${product.minus || '-'}</td>
      <td>${product.notes || '-'}</td>
      <td>${product.boxCode || '-'}</td>
      <td>${product.coverCode || '-'}</td>
      <td class="action-btns">
        <button class="btn-add" onclick="editProduct('${product.id}')">✏️ تعديل</button>
        <button class="btn-remove" onclick="deleteProduct('${product.id}')">🗑️ حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function searchProducts() {
  const searchTerm = document.getElementById("product-search").value.toLowerCase();
  const rows = document.querySelectorAll("#products-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

function updateGroupsDropdown() {
  const select = document.getElementById("product-group");
  select.innerHTML = '<option value="">اختر مجموعة...</option>';
  
  groups.forEach(group => {
    const option = document.createElement("option");
    option.value = group.name;
    option.textContent = group.name;
    select.appendChild(option);
  });
}

// ===== دوال شاشة الرصيد =====
function renderInventoryTable() {
  const tbody = document.getElementById("inventory-list");
  tbody.innerHTML = "";
  
  inventory.forEach(item => {
    const product = products.find(p => p.id == item.productId) || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.productId}</td>
      <td>${item.group || product.group || '-'}</td>
      <td>${item.productName || product.name || '-'}</td>
      <td>${item.plus || product.plus || '-'}</td>
      <td>${item.minus || product.minus || '-'}</td>
      <td>${item.boxColor || product.boxColor || '-'}</td>
      <td>${item.coverColor || product.coverColor || '-'}</td>
      <td>${item.boxType || product.boxType || '-'}</td>
      <td>${item.coverType || product.coverType || '-'}</td>
      <td>${item.direction || product.direction || '-'}</td>
      <td><input type="number" value="${item.quantity || 0}" onchange="updateInventoryQuantity('${item.productId}', this.value)"></td>
      <td>${item.lastUpdated || '-'}</td>
      <td>
        <button class="btn btn-info" onclick="updateInventoryItem('${item.productId}')">🔄 تحديث</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function updateInventoryQuantity(productId, quantity) {
  const item = inventory.find(i => i.productId == productId);
  if (item) {
    item.quantity = parseFloat(quantity) || 0;
    item.lastUpdated = new Date().toLocaleString("ar-EG");
    localStorage.setItem("inventory", JSON.stringify(inventory));
  }
}

function updateInventoryItem(productId) {
  const item = inventory.find(i => i.productId == productId);
  const product = products.find(p => p.id == productId);
  
  if (item && product) {
    item.productName = product.name;
    item.group = product.group;
    item.plus = product.plus;
    item.minus = product.minus;
    item.boxColor = product.boxColor;
    item.coverColor = product.coverColor;
    item.boxType = product.boxType;
    item.coverType = product.coverType;
    item.direction = product.direction;
    item.lastUpdated = new Date().toLocaleString("ar-EG");
    
    localStorage.setItem("inventory", JSON.stringify(inventory));
    renderInventoryTable();
  }
}

function updateAllInventory() {
  inventory.forEach(item => {
    const product = products.find(p => p.id == item.productId);
    if (product) {
      item.productName = product.name;
      item.group = product.group;
      item.plus = product.plus;
      item.minus = product.minus;
      item.boxColor = product.boxColor;
      item.coverColor = product.coverColor;
      item.boxType = product.boxType;
      item.coverType = product.coverType;
      item.direction = product.direction;
      item.lastUpdated = new Date().toLocaleString("ar-EG");
    }
  });
  
  localStorage.setItem("inventory", JSON.stringify(inventory));
  renderInventoryTable();
  alert("تم تحديث جميع الأصناف في المخزون");
}

function searchInventory() {
  const searchTerm = document.getElementById("inventory-search").value.toLowerCase();
  const rows = document.querySelectorAll("#inventory-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

// ===== دوال شاشة المجموعات =====
function addGroup() {
  const name = document.getElementById("group-name").value.trim();
  
  if (!name) {
    alert("الرجاء إدخال اسم المجموعة");
    return;
  }
  
  const group = {
    id: editingGroupId || Date.now().toString(),
    name,
    notes: document.getElementById("group-notes").value
  };
  
  if (editingGroupId) {
    // تحديث المجموعة الموجودة
    const index = groups.findIndex(g => g.id == editingGroupId);
    if (index !== -1) {
      groups[index] = group;
    }
    editingGroupId = null;
    document.getElementById("group-action-btn").textContent = "➕ إضافة مجموعة";
    document.getElementById("cancel-group-edit-btn").style.display = "none";
    document.getElementById("group-form-title").textContent = "إضافة مجموعة جديدة";
  } else {
    // إضافة مجموعة جديدة
    groups.push(group);
  }
  
  localStorage.setItem("groups", JSON.stringify(groups));
  renderGroupsTable();
  updateGroupsDropdown();
  resetGroupForm();
}

function editGroup(groupId) {
  const group = groups.find(g => g.id == groupId);
  if (!group) return;
  
  editingGroupId = groupId;
  document.getElementById("group-name").value = group.name;
  document.getElementById("group-notes").value = group.notes || "";
  
  document.getElementById("group-action-btn").textContent = "💾 حفظ التعديلات";
  document.getElementById("cancel-group-edit-btn").style.display = "inline-block";
  document.getElementById("group-form-title").textContent = "تعديل مجموعة";
}

function deleteGroup(groupId) {
  if (confirm("هل أنت متأكد من حذف هذه المجموعة؟ سيتم إزالة ارتباطها بالأصناف.")) {
    groups = groups.filter(g => g.id != groupId);
    
    // إزالة المجموعة من الأصناف المرتبطة بها
    products.forEach(product => {
      if (product.group === groupId) {
        product.group = "";
      }
    });
    
    localStorage.setItem("groups", JSON.stringify(groups));
    localStorage.setItem("products", JSON.stringify(products));
    renderGroupsTable();
    updateGroupsDropdown();
    renderProductsTable();
  }
}

function resetGroupForm() {
  document.getElementById("group-name").value = "";
  document.getElementById("group-notes").value = "";
}

function cancelGroupEdit() {
  editingGroupId = null;
  document.getElementById("group-action-btn").textContent = "➕ إضافة مجموعة";
  document.getElementById("cancel-group-edit-btn").style.display = "none";
  document.getElementById("group-form-title").textContent = "إضافة مجموعة جديدة";
  resetGroupForm();
}

function renderGroupsTable() {
  const tbody = document.getElementById("groups-list");
  tbody.innerHTML = "";
  
  groups.forEach(group => {
    const productCount = products.filter(p => p.group === group.name).length;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${group.name}</td>
      <td>${productCount}</td>
      <td>${group.notes || '-'}</td>
      <td class="action-btns">
        <button class="btn-add" onclick="editGroup('${group.id}')">✏️ تعديل</button>
        <button class="btn-remove" onclick="deleteGroup('${group.id}')">🗑️ حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function searchGroups() {
  const searchTerm = document.getElementById("group-search").value.toLowerCase();
  const rows = document.querySelectorAll("#groups-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

// ===== دوال شاشة الخطوط =====
function addLine() {
  const number = document.getElementById("line-number").value.trim();
  const name = document.getElementById("line-name").value.trim();
  
  if (!number) {
    alert("الرجاء إدخال رقم الخط");
    return;
  }
  
  const line = {
    id: editingLineId || Date.now().toString(),
    number,
    name,
    location: document.getElementById("line-location").value,
    notes: document.getElementById("line-notes").value
  };
  
  if (editingLineId) {
    // تحديث الخط الموجود
    const index = lines.findIndex(l => l.id == editingLineId);
    if (index !== -1) {
      lines[index] = line;
    }
    editingLineId = null;
    document.getElementById("line-action-btn").textContent = "➕ إضافة خط";
    document.getElementById("cancel-line-edit-btn").style.display = "none";
    document.getElementById("line-form-title").textContent = "إضافة خط جديد";
  } else {
    // إضافة خط جديد
    lines.push(line);
  }
  
  localStorage.setItem("lines", JSON.stringify(lines));
  renderLinesTable();
  resetLineForm();
}

function editLine(lineId) {
  const line = lines.find(l => l.id == lineId);
  if (!line) return;
  
  editingLineId = lineId;
  document.getElementById("line-number").value = line.number;
  document.getElementById("line-name").value = line.name || "";
  document.getElementById("line-location").value = line.location || "";
  document.getElementById("line-notes").value = line.notes || "";
  
  document.getElementById("line-action-btn").textContent = "💾 حفظ التعديلات";
  document.getElementById("cancel-line-edit-btn").style.display = "inline-block";
  document.getElementById("line-form-title").textContent = "تعديل خط";
}

function deleteLine(lineId) {
  if (confirm("هل أنت متأكد من حذف هذا الخط؟")) {
    lines = lines.filter(l => l.id != lineId);
    localStorage.setItem("lines", JSON.stringify(lines));
    renderLinesTable();
  }
}

function resetLineForm() {
  document.getElementById("line-number").value = "";
  document.getElementById("line-name").value = "";
  document.getElementById("line-location").value = "";
  document.getElementById("line-notes").value = "";
}

function cancelLineEdit() {
  editingLineId = null;
  document.getElementById("line-action-btn").textContent = "➕ إضافة خط";
  document.getElementById("cancel-line-edit-btn").style.display = "none";
  document.getElementById("line-form-title").textContent = "إضافة خط جديد";
  resetLineForm();
}

function renderLinesTable() {
  const tbody = document.getElementById("lines-list");
  tbody.innerHTML = "";
  
  lines.forEach(line => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${line.number}</td>
      <td>${line.name || '-'}</td>
      <td>${line.location || '-'}</td>
      <td>${line.notes || '-'}</td>
      <td class="action-btns">
        <button class="btn-add" onclick="editLine('${line.id}')">✏️ تعديل</button>
        <button class="btn-remove" onclick="deleteLine('${line.id}')">🗑️ حذف</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function searchLines() {
  const searchTerm = document.getElementById("line-search").value.toLowerCase();
  const rows = document.querySelectorAll("#lines-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

// ===== دوال عرض البيانات المحفوظة =====
function loadSavedData() {
  entries = JSON.parse(localStorage.getItem("batteryData") || "[]");
  const headerRow = document.getElementById("data-header");
  const dataBody = document.getElementById("saved-data-body");
  
  document.getElementById("data-count").textContent = entries.length;
  document.getElementById("last-update").textContent = 
    localStorage.getItem("lastUpdate") || "غير معروف";
  
  headerRow.innerHTML = "";
  if (entries.length > 0) {
    fieldNames.forEach(field => {
      const th = document.createElement("th");
      th.textContent = field;
      headerRow.appendChild(th);
    });
    
    const actionTh = document.createElement("th");
    actionTh.textContent = "الإجراءات";
    headerRow.appendChild(actionTh);
  }
  
  dataBody.innerHTML = "";
  entries.forEach((entry, index) => {
    const tr = document.createElement("tr");
    tr.dataset.index = index;
    
    fieldNames.forEach(field => {
      const td = document.createElement("td");
      td.textContent = entry[field] || "-";
      tr.appendChild(td);
    });
    
    const actionTd = document.createElement("td");
    actionTd.innerHTML = `
      <button class="btn btn-primary" onclick="editSavedEntry(${index})">✏️ تعديل</button>
      <button class="btn btn-danger" onclick="deleteSavedEntry(${index})">🗑️ حذف</button>
    `;
    tr.appendChild(actionTd);
    
    dataBody.appendChild(tr);
  });
}

function editSavedEntry(index) {
  const entry = entries[index];
  if (!entry) return;
  
  // نقل البيانات إلى شاشة التجميع
  showSection('assembly-section');
  tempEntries = [entry];
  loadDataIntoTable();
  
  // حذف السجل القديم
  entries.splice(index, 1);
  localStorage.setItem("batteryData", JSON.stringify(entries));
  loadSavedData();
}

function deleteSavedEntry(index) {
  if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
    entries.splice(index, 1);
    localStorage.setItem("batteryData", JSON.stringify(entries));
    loadSavedData();
  }
}

function filterData() {
  const searchTerm = document.getElementById("data-search").value.toLowerCase();
  const rows = document.querySelectorAll("#saved-data-body tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

function exportAllData() {
  if (entries.length === 0) {
    alert("لا توجد بيانات محفوظة للتصدير");
    return;
  }
  
  const csvContent = [
    fieldNames.join(","),
    ...entries.map(item => fieldNames.map(field => item[field] || "").join(","))
  ].join("\n");
  
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `بيانات_التجميع_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
}

// ===== دوال شاشة المشرفين =====
function addSupervisor() {
  const name = document.getElementById("supervisor-name-input").value.trim();
  if (!name) {
    alert("الرجاء إدخال اسم المشرف");
    return;
  }
  
  // حفظ المشرف في localStorage
  const supervisors = JSON.parse(localStorage.getItem("supervisors") || []);
  supervisors.push(name);
  localStorage.setItem("supervisors", JSON.stringify(supervisors));
  
  // تحديث القائمة
  renderSupervisorsList();
  
  // مسح حقل الإدخال
  document.getElementById("supervisor-name-input").value = "";
}

function deleteSupervisor(index) {
  const supervisors = JSON.parse(localStorage.getItem("supervisors") || []);
  supervisors.splice(index, 1);
  localStorage.setItem("supervisors", JSON.stringify(supervisors));
  renderSupervisorsList();
}

function renderSupervisorsList() {
  const tbody = document.getElementById("supervisors-list");
  tbody.innerHTML = "";
  
  const supervisors = JSON.parse(localStorage.getItem("supervisors") || "[]");
  supervisors.forEach((name, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${name}</td>
      <td><button class="btn btn-danger" onclick="deleteSupervisor(${index})">🗑️ حذف</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== دوال شاشة الأكواد الثابتة =====
function addFixedCode() {
  const code = document.getElementById("fixed-code-input").value.trim();
  if (!code) {
    alert("الرجاء إدخال كود");
    return;
  }
  
  if (fixedCodes.includes(code)) {
    alert("هذا الكود موجود بالفعل");
    return;
  }
  
  fixedCodes.push(code);
  renderFixedCodesList();
  document.getElementById("fixed-code-input").value = "";
}

function deleteFixedCode(index) {
  fixedCodes.splice(index, 1);
  renderFixedCodesList();
}

function renderFixedCodesList() {
  const tbody = document.getElementById("fixed-codes-list");
  tbody.innerHTML = "";
  
  fixedCodes.forEach((code, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${code}</td>
      <td><button class="btn btn-danger" onclick="deleteFixedCode(${index})">🗑️ حذف</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== دوال قسم التقارير =====
function generateReports() {
  const reportsContainer = document.getElementById("reports-container");
  reportsContainer.innerHTML = "";
  
  // تقرير الأصناف
  const productsReport = document.createElement("div");
  productsReport.className = "report-card";
  productsReport.innerHTML = `
    <h3>تقرير الأصناف</h3>
    <p><strong>عدد الأصناف:</strong> ${products.length}</p>
    <p><strong>عدد المجموعات:</strong> ${groups.length}</p>
  `;
  reportsContainer.appendChild(productsReport);
  
  // تقرير المخزون
  const inventoryReport = document.createElement("div");
  inventoryReport.className = "report-card";
  
  const totalQuantity = inventory.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
  const lowStock = inventory.filter(item => (parseFloat(item.quantity) || 0) < 10).length;
  
  inventoryReport.innerHTML = `
    <h3>تقرير المخزون</h3>
    <p><strong>إجمالي الكمية:</strong> ${totalQuantity}</p>
    <p><strong>عدد الأصناف منخفضة المخزون (&lt; 10):</strong> ${lowStock}</p>
  `;
  reportsContainer.appendChild(inventoryReport);
  
  // تقرير التجميع
  const assemblyReport = document.createElement("div");
  assemblyReport.className = "report-card";
  assemblyReport.innerHTML = `
    <h3>تقرير التجميع</h3>
    <p><strong>عدد سجلات التجميع:</strong> ${entries.length}</p>
    <p><strong>آخر تحديث:</strong> ${localStorage.getItem("lastUpdate") || "غير معروف"}</p>
  `;
  reportsContainer.appendChild(assemblyReport);
  
  // تقرير التسجيل اليومي
  const dailyReport = document.createElement("div");
  dailyReport.className = "report-card";
  dailyReport.innerHTML = `
    <h3>تقرير التسجيل اليومي</h3>
    <p><strong>عدد السجلات:</strong> ${dailyEntries.length}</p>
    <p><strong>آخر تحديث:</strong> ${localStorage.getItem("dailyLastUpdate") || "غير معروف"}</p>
  `;
  reportsContainer.appendChild(dailyReport);
}

function exportReports() {
  const reports = [
    ["نوع التقرير", "المعلومات", "القيمة"],
    ["الأصناف", "عدد الأصناف", products.length],
    ["الأصناف", "عدد المجموعات", groups.length],
    ["المخزون", "إجمالي الكمية", inventory.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0)],
    ["المخزون", "أصناف منخفضة المخزون", inventory.filter(item => (parseFloat(item.quantity) || 0) < 10).length],
    ["التجميع", "عدد السجلات", entries.length],
    ["التجميع", "آخر تحديث", localStorage.getItem("lastUpdate") || "غير معروف"],
    ["التسجيل اليومي", "عدد السجلات", dailyEntries.length],
    ["التسجيل اليومي", "آخر تحديث", localStorage.getItem("dailyLastUpdate") || "غير معروف"]
  ];
  
  const csvContent = reports.map(row => row.join(",")).join("\n");
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `تقارير_النظام_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
}

// ===== النسخ الاحتياطي والاستعادة =====
function backupData() {
  const backup = {
    products,
    groups,
    lines,
    inventory,
    entries,
    dailyEntries,
    fixedCodes,
    supervisors: JSON.parse(localStorage.getItem("supervisors") || []),
    users,
    lastUpdate: localStorage.getItem("lastUpdate"),
    dailyLastUpdate: localStorage.getItem("dailyLastUpdate")
  };
  
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `نسخة_احتياطية_${new Date().toLocaleDateString("ar-EG")}.json`;
  a.click();
}

function restoreData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!confirm("هل أنت متأكد من استعادة النسخة الاحتياطية؟ سيتم استبدال جميع البيانات الحالية.")) {
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      
      // استعادة البيانات
      products = backup.products || [];
      groups = backup.groups || [];
      lines = backup.lines || [];
      inventory = backup.inventory || [];
      entries = backup.entries || [];
      dailyEntries = backup.dailyEntries || [];
      fixedCodes = backup.fixedCodes || ["FC-001", "FC-002", "FC-003", "FC-004"];
      
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("groups", JSON.stringify(groups));
      localStorage.setItem("lines", JSON.stringify(lines));
      localStorage.setItem("inventory", JSON.stringify(inventory));
      localStorage.setItem("batteryData", JSON.stringify(entries));
      localStorage.setItem("dailyData", JSON.stringify(dailyEntries));
      localStorage.setItem("supervisors", JSON.stringify(backup.supervisors || []));
      localStorage.setItem("erpUsers", JSON.stringify(backup.users || users));
      localStorage.setItem("lastUpdate", backup.lastUpdate || new Date().toLocaleString("ar-EG"));
      localStorage.setItem("dailyLastUpdate", backup.dailyLastUpdate || new Date().toLocaleString("ar-EG"));
      
      // تحديث الواجهة
      initPage();
      alert("تم استعادة النسخة الاحتياطية بنجاح");
    } catch (error) {
      alert("حدث خطأ أثناء استعادة النسخة الاحتياطية: " + error.message);
    }
  };
  reader.readAsText(file);
}

// ===== دوال عامة =====
function showSection(sectionId) {
  // إخفاء كل الأقسام
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  
  // إلغاء تنشيط كل أزرار التبويب
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // إظهار القسم المطلوب
  document.getElementById(sectionId).classList.add('active');
  
  // تنشيط زر التبويب المحدد
  event.target.classList.add('active');
}

// تهيئة الصفحة عند التحميل
function initPage() {
  if (currentUser) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-sections').style.display = 'block';
    document.getElementById('user-info').textContent = `مرحباً ${currentUser.name}`;
  } else {
    showLoginForm();
  }

  createExcelTable();
  renderGroupsTable();
  renderLinesTable();
  updateGroupsDropdown();
  renderProductsTable();
  renderInventoryTable();
  updateAutoCode();
  createDailyTable();
  renderSupervisorsList();
  renderFixedCodesList();
  
  // تحميل بيانات التسجيل اليومي إذا لم تكن موجودة
  if (!localStorage.getItem("dailyData")) {
    localStorage.setItem("dailyData", "[]");
  }
  
  // تحميل المشرفين إذا لم يكونوا موجودين
  if (!localStorage.getItem("supervisors")) {
    localStorage.setItem("supervisors", "[]");
  }
  
  // إخفاء بعض الأزرار حسب الصلاحيات
  if (currentUser && currentUser.role !== 'admin') {
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = 'none';
    });
  }
  
  // ربط حدث البحث عند الضغط على Enter
  document.getElementById('product-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchProducts();
    }
  });

  document.getElementById('inventory-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchInventory();
    }
  });

  document.getElementById('group-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchGroups();
    }
  });

  document.getElementById('line-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchLines();
    }
  });

  document.getElementById('data-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      filterData();
    }
  });

  document.getElementById('daily-data-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      filterDailyData();
    }
  });
}

// بدء التطبيق
document.addEventListener('DOMContentLoaded', function() {
  initPage();
});
</script>
</body>
</html>