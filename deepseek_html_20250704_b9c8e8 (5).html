<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ูุธุงู ERP - ุฅุฏุงุฑุฉ ุงูุฃุตูุงู ูุงูุชุฌููุน ูุงูุฑุตูุฏ</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f4f4f4; 
      padding: 20px;
      margin: 0;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #007bff;
    }
    .tab-btn {
      padding: 12px 24px;
      background: #e9ecef;
      border: none;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      margin: 0 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: #007bff;
      color: white;
    }
    .section {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .section.active {
      display: block;
    }
    h1, h2 { 
      text-align: center; 
      color: #2c3e50;
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    .container { 
      background: #fff; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    .excel-style {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .excel-style th, .excel-style td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      min-width: 100px;
    }
    .excel-style th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .excel-style td {
      background-color: white;
      height: 30px;
    }
    .excel-style input, .excel-style select {
      width: 100%;
      border: none;
      padding: 5px;
      box-sizing: border-box;
      background: transparent;
    }
    .excel-style input:focus, .excel-style select:focus {
      outline: 2px solid #007bff;
      background: #fff;
    }
    .selected-cell {
      background-color: #e6f2ff !important;
      outline: 2px solid #007bff;
    }
    .action-btns { 
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
    }
    .action-btns button { 
      padding: 4px 10px; 
      font-weight: bold; 
      border: none; 
      color: white; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .btn-add { 
      background-color: #28a745; 
    }
    .btn-remove { 
      background-color: #dc3545; 
    }
    #save-button, #cancel-button, .btn {
      margin-top: 10px; 
      padding: 10px 20px; 
      font-size: 16px; 
      margin-left: 10px;
      border: none; 
      border-radius: 5px; 
      cursor: pointer;
      color: white;
      transition: background 0.3s;
    }
    #save-button, .btn-primary {
      background-color: #007bff;
    }
    #save-button:hover, .btn-primary:hover {
      background-color: #0069d9;
    }
    #cancel-button, .btn-secondary {
      background-color: #6c757d;
    }
    #cancel-button:hover, .btn-secondary:hover {
      background-color: #5a6268;
    }
    .btn-success {
      background-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
    }
    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    .btn-warning:hover {
      background-color: #e0a800;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .btn-info {
      background-color: #17a2b8;
    }
    .btn-info:hover {
      background-color: #138496;
    }
    .product-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #495057;
    }
    .auto-code {
      background-color: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
      color: #495057;
      text-align: center;
    }
    .search-box {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .search-box input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .search-box button {
      padding: 10px 20px;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .info-box {
      background: #e7f3fe;
      border-left: 4px solid #2196F3;
      padding: 12px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .highlight {
      background-color: #fff9c4;
      transition: background-color 0.5s;
    }
    .code-input {
      background-color: #e9ecef;
      font-weight: bold;
      text-align: center;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    .total-row {
      background-color: #f8f9fa !important;
      font-weight: bold;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .report-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .report-card h3 {
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-top: 0;
    }
    .form-control {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .admin-only {
      display: none;
    }
    #data-section table {
      min-width: 100%;
    }
    #data-section .info-box {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    #data-search {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-left: 10px;
    }
    .draft-notice {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      text-align: center;
      border-left: 4px solid #ffeeba;
    }
    .code-box {
      background-color: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
    }
    .read-only-cell {
      background-color: #f8f9fa !important;
      font-weight: bold;
      text-align: center;
    }
    /* ุฃููุงุท ุดุงุดุฉ ุงูุฑุตูุฏ */
    #inventory-section input[type="number"] {
      text-align: center;
      padding: 5px;
    }
    #inventory-section .form-control {
      width: auto;
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- ูุณู ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="login-section" style="max-width: 400px; margin: 50px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
    <h1 style="text-align: center;">ุชุณุฌูู ุงูุฏุฎูู</h1>
    <div class="form-group">
      <label>ุงุณู ุงููุณุชุฎุฏู</label>
      <input type="text" id="login-username" class="form-control">
    </div>
    <div class="form-group">
      <label>ูููุฉ ุงููุฑูุฑ</label>
      <input type="password" id="login-password" class="form-control">
    </div>
    <button onclick="login()" class="btn btn-primary" style="width: 100%;">ุฏุฎูู</button>
  </div>

  <div id="main-sections" style="display: none;">
    <!-- ุดุฑูุท ูุนูููุงุช ุงููุณุชุฎุฏู -->
    <div style="text-align: left; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
      <span id="user-info"></span>
      <button onclick="logout()" class="btn btn-danger" style="float: left;">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    </div>

    <!-- ุชุจููุจุงุช ุงููุธุงู -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showSection('assembly-section')">ุดุงุดุฉ ุงูุชุฌููุน</button>
      <button class="tab-btn" onclick="showSection('products-section')">ุดุงุดุฉ ุงูุฃุตูุงู</button>
      <button class="tab-btn" onclick="showSection('inventory-section')">ุดุงุดุฉ ุงูุฑุตูุฏ</button>
      <button class="tab-btn" onclick="showSection('groups-section')">ุดุงุดุฉ ุงููุฌููุนุงุช</button>
      <button class="tab-btn" onclick="showSection('lines-section')">ุดุงุดุฉ ุงูุฎุทูุท</button>
      <button class="tab-btn" onclick="showSection('daily-register-section')">ุงูุชุณุฌูู ุงููููู</button>
      <button class="tab-btn" onclick="showSection('daily-data-section'); loadDailyData()">ุจูุงูุงุช ุงูุชุณุฌูู</button>
      <button class="tab-btn" onclick="showSection('data-section'); loadSavedData()">ุนุฑุถ ุงูุจูุงูุงุช</button>
      <button class="tab-btn" onclick="showSection('reports-section'); generateReports()">ุงูุชูุงุฑูุฑ</button>
      <button class="tab-btn" onclick="showSection('supervisors-section')">ุงููุดุฑููู</button>
      <button class="tab-btn" onclick="showSection('fixedcodes-section')">ุงูุฃููุงุฏ ุงูุซุงุจุชุฉ</button>
    </div>

    <!-- ุดุงุดุฉ ุงูุชุฌููุน -->
    <div id="assembly-section" class="section active">
      <div class="container">
        <h1>ูุธุงู ERP ูุชุณุฌูู ุงูุชุฌููุน</h1>
        
        <div class="draft-notice">
          <strong>ููุงุญุธุฉ:</strong> ูุฐู ุงูุจูุงูุงุช ูุคูุชุฉ ุญุชู ุชููู ุจุงูุญูุธ. ุณูุชู ูุณุญูุง ุชููุงุฆููุง ุนูุฏ ุงูุงูุชูุงู ูุดุงุดุฉ ุฃุฎุฑู.
        </div>
        
        <div class="toolbar">
          <button class="btn btn-success" onclick="addNewRow()">โ ุตู ุฌุฏูุฏ</button>
          <button class="btn btn-danger" onclick="deleteSelectedRow()">๐๏ธ ุญุฐู ุงูุตู</button>
          <button id="save-assembly-btn" class="btn btn-primary" onclick="saveAssemblyData()">๐พ ุญูุธ ุงูุชุฌููุน</button>
          <div id="save-message" class="success-message"></div>
        </div>
        
        <div id="excel-container">
          <table class="excel-style" id="excel-table">
            <thead>
              <tr id="header-row"></tr>
            </thead>
            <tbody id="data-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงูุฃุตูุงู -->
    <div id="products-section" class="section">
      <div class="container">
        <h1>ุฅุฏุงุฑุฉ ุงูุฃุตูุงู</h1>
        
        <div class="product-form">
          <h2 id="form-title">ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h2>
          <div class="form-group">
            <label>ููุฏ ุงูุตูู <span id="code-status">(ุชููุงุฆู)</span></label>
            <div class="auto-code" id="auto-code">ูุชู ุชูููุฏู ุชููุงุฆูุงู</div>
          </div>
          <div class="form-group">
            <label>ุงุณู ุงูุตูู</label>
            <input type="text" id="product-name" placeholder="ุฃุฏุฎู ุงุณู ุงูุตูู" class="form-control">
          </div>
          <div class="form-group">
            <label>ุงููุฌููุนุฉ</label>
            <select id="product-group" class="form-control">
              <option value="">ุงุฎุชุฑ ูุฌููุนุฉ...</option>
            </select>
          </div>
          <div class="form-group">
            <label>ููุน ุงูุบุทุงุก</label>
            <input type="text" id="cover-type" placeholder="ุฃุฏุฎู ููุน ุงูุบุทุงุก" class="form-control">
          </div>
          <div class="form-group">
            <label>ููุน ุงูุนูุจุฉ</label>
            <input type="text" id="box-type" placeholder="ุฃุฏุฎู ููุน ุงูุนูุจุฉ" class="form-control">
          </div>
          <div class="form-group">
            <label>ููู ุงูุนูุจุฉ</label>
            <input type="text" id="box-color" placeholder="ุฃุฏุฎู ููู ุงูุนูุจุฉ" class="form-control">
          </div>
          <div class="form-group">
            <label>ููู ุงูุบุทุงุก</label>
            <input type="text" id="cover-color" placeholder="ุฃุฏุฎู ููู ุงูุบุทุงุก" class="form-control">
          </div>
          <div class="form-group">
            <label>ุงูุงุชุฌุงู</label>
            <select id="direction" class="form-control">
              <option value="">ุงุฎุชุฑ ุงูุงุชุฌุงู</option>
              <option value="L">L</option>
              <option value="R">R</option>
            </select>
          </div>
          <div class="form-group">
            <label>ห (ุงููููุฉ ุงูููุฌุจุฉ)</label>
            <input type="number" step="0.01" id="product-plus" placeholder="ุฃุฏุฎู ูููุฉ ห" class="form-control">
          </div>
          <div class="form-group">
            <label>ห (ุงููููุฉ ุงูุณุงูุจุฉ)</label>
            <input type="number" step="0.01" id="product-minus" placeholder="ุฃุฏุฎู ูููุฉ ห" class="form-control">
          </div>
          <div class="form-group">
            <label>ููุงุญุธุงุช</label>
            <input type="text" id="product-notes" placeholder="ุฃุฏุฎู ุฃู ููุงุญุธุงุช" class="form-control">
          </div>
          <div class="form-group">
            <label>ููุฏ ุงูุนูุจ</label>
            <input type="text" id="box-code" placeholder="ุฃุฏุฎู ููุฏ ุงูุนูุจ" class="form-control">
          </div>
          <div class="form-group">
            <label>ููุฏ ุงูุบุทุงุก</label>
            <input type="text" id="cover-code" placeholder="ุฃุฏุฎู ููุฏ ุงูุบุทุงุก" class="form-control">
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="product-action-btn" onclick="addProduct()">โ ุฅุถุงูุฉ ุตูู</button>
            <button class="btn btn-secondary" id="cancel-edit-btn" style="display:none;" onclick="cancelEdit()">โ ุฅูุบุงุก ุงูุชุนุฏูู</button>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="product-search" placeholder="ุงุจุญุซ ุจุงุณู ุงูุตูู ุฃู ุงูููุฏ..." class="form-control">
          <button class="btn btn-primary" onclick="searchProducts()">๐ ุจุญุซ</button>
        </div>

        <table id="products-table" class="excel-style">
          <thead>
            <tr>
              <th>ููุฏ ุงูุตูู</th>
              <th>ุงุณู ุงูุตูู</th>
              <th>ุงููุฌููุนุฉ</th>
              <th>ููุน ุงูุบุทุงุก</th>
              <th>ููุน ุงูุนูุจุฉ</th>
              <th>ููู ุงูุนูุจุฉ</th>
              <th>ููู ุงูุบุทุงุก</th>
              <th>ุงูุงุชุฌุงู</th>
              <th>ห</th>
              <th>ห</th>
              <th>ููุงุญุธุงุช</th>
              <th>ููุฏ ุงูุนูุจ</th>
              <th>ููุฏ ุงูุบุทุงุก</th>
              <th>ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="products-list"></tbody>
        </table>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงูุฑุตูุฏ -->
    <div id="inventory-section" class="section">
      <div class="container">
        <h1>ุฅุฏุงุฑุฉ ุฑุตูุฏ ุงูุฃุตูุงู</h1>
        
        <div class="info-box">
          <strong>ููุงุญุธุฉ:</strong> ูุชู ุชุญุฏูุซ ุงูุฑุตูุฏ ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ ุฃุตูุงู ุฌุฏูุฏุฉ. ููููู ุชุนุฏูู ุงููููุงุช ูุฏููุงู ุนูุฏ ุงูุญุงุฌุฉ.
        </div>
        
        <div class="search-box">
          <input type="text" id="inventory-search" placeholder="ุงุจุญุซ ุจุงุณู ุงูุตูู ุฃู ุงูููุฏ..." class="form-control">
          <button class="btn btn-primary" onclick="searchInventory()">๐ ุจุญุซ</button>
          <button class="btn btn-success" onclick="updateAllInventory()">๐ ุชุญุฏูุซ ุงููู</button>
        </div>
        
        <table id="inventory-table" class="excel-style">
          <thead>
            <tr>
              <th>ููุฏ ุงูุตูู</th>
              <th>ุงููุฌููุนุฉ</th>
              <th>ุงุณู ุงูุตูู</th>
              <th>ุงูุชูููู +</th>
              <th>ุงูุชูููู -</th>
              <th>ููู ุงูุนูุจุฉ</th>
              <th>ููู ุงูุบุทุง</th>
              <th>ููุน ุงูุนูุจุฉ</th>
              <th>ููุน ุงูุบุทุง</th>
              <th>ุงูุงุชุฌุงุฉ</th>
              <th>ุงูุฑุตูุฏ ุงูุญุงูู</th>
              <th>ุขุฎุฑ ุชุญุฏูุซ</th>
              <th>ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="inventory-list"></tbody>
        </table>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงููุฌููุนุงุช -->
    <div id="groups-section" class="section">
      <div class="container">
        <h1>ุฅุฏุงุฑุฉ ุงููุฌููุนุงุช</h1>
        
        <div class="product-form">
          <h2 id="group-form-title">ุฅุถุงูุฉ ูุฌููุนุฉ ุฌุฏูุฏุฉ</h2>
          <div class="form-group">
            <label>ุงุณู ุงููุฌููุนุฉ</label>
            <input type="text" id="group-name" placeholder="ุฃุฏุฎู ุงุณู ุงููุฌููุนุฉ" class="form-control">
          </div>
          <div class="form-group">
            <label>ููุงุญุธุงุช</label>
            <input type="text" id="group-notes" placeholder="ุฃุฏุฎู ุฃู ููุงุญุธุงุช" class="form-control">
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="group-action-btn" onclick="addGroup()">โ ุฅุถุงูุฉ ูุฌููุนุฉ</button>
            <button class="btn btn-secondary" id="cancel-group-edit-btn" style="display:none;" onclick="cancelGroupEdit()">โ ุฅูุบุงุก ุงูุชุนุฏูู</button>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="group-search" placeholder="ุงุจุญุซ ุจุงุณู ุงููุฌููุนุฉ..." class="form-control">
          <button class="btn btn-primary" onclick="searchGroups()">๐ ุจุญุซ</button>
        </div>

        <table id="groups-table" class="excel-style">
          <thead>
            <tr>
              <th>ุงุณู ุงููุฌููุนุฉ</th>
              <th>ุนุฏุฏ ุงูุฃุตูุงู</th>
              <th>ููุงุญุธุงุช</th>
              <th>ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="groups-list"></tbody>
        </table>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงูุฎุทูุท -->
    <div id="lines-section" class="section">
      <div class="container">
        <h1>ุฅุฏุงุฑุฉ ุงูุฎุทูุท</h1>
        
        <div class="product-form">
          <h2 id="line-form-title">ุฅุถุงูุฉ ุฎุท ุฌุฏูุฏ</h2>
          <div class="form-group">
            <label>ุฑูู ุงูุฎุท</label>
            <input type="text" id="line-number" placeholder="ุฃุฏุฎู ุฑูู ุงูุฎุท" class="form-control">
          </div>
          <div class="form-group">
            <label>ุงุณู ุงูุฎุท</label>
            <input type="text" id="line-name" placeholder="ุฃุฏุฎู ุงุณู ุงูุฎุท" class="form-control">
          </div>
          <div class="form-group">
            <label>ุงููููุน</label>
            <input type="text" id="line-location" placeholder="ุฃุฏุฎู ูููุน ุงูุฎุท" class="form-control">
          </div>
          <div class="form-group">
            <label>ููุงุญุธุงุช</label>
            <input type="text" id="line-notes" placeholder="ุฃุฏุฎู ุฃู ููุงุญุธุงุช" class="form-control">
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="line-action-btn" onclick="addLine()">โ ุฅุถุงูุฉ ุฎุท</button>
            <button class="btn btn-secondary" id="cancel-line-edit-btn" style="display:none;" onclick="cancelLineEdit()">โ ุฅูุบุงุก ุงูุชุนุฏูู</button>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="line-search" placeholder="ุงุจุญุซ ุจุฑูู ุงูุฎุท ุฃู ุงุณูู..." class="form-control">
          <button class="btn btn-primary" onclick="searchLines()">๐ ุจุญุซ</button>
        </div>

        <table id="lines-table" class="excel-style">
          <thead>
            <tr>
              <th>ุฑูู ุงูุฎุท</th>
              <th>ุงุณู ุงูุฎุท</th>
              <th>ุงููููุน</th>
              <th>ููุงุญุธุงุช</th>
              <th>ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="lines-list"></tbody>
        </table>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงูุชุณุฌูู ุงููููู -->
    <div id="daily-register-section" class="section">
      <div class="container">
        <h1>ุงูุชุณุฌูู ุงููููู</h1>
        
        <div class="draft-notice">
          <strong>ููุงุญุธุฉ:</strong> ูุชู ุชุญุฏูุซ ุงูุฑุตูุฏ ุชููุงุฆูุงู ุนูุฏ ุญูุธ ุงูุจูุงูุงุช.
        </div>
        
        <div class="toolbar">
          <button class="btn btn-success" onclick="addNewDailyRow()">โ ุตู ุฌุฏูุฏ</button>
          <button class="btn btn-danger" onclick="deleteSelectedDailyRow()">๐๏ธ ุญุฐู ุงูุตู</button>
          <button id="save-daily-btn" class="btn btn-primary" onclick="saveDailyData()">๐พ ุญูุธ ุงูุจูุงูุงุช</button>
          <div id="daily-save-message" class="success-message"></div>
        </div>
        
        <div id="daily-excel-container">
          <table class="excel-style" id="daily-excel-table">
            <thead>
              <tr id="daily-header-row"></tr>
            </thead>
            <tbody id="daily-data-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุจูุงูุงุช ุงูุชุณุฌูู ุงููููู -->
    <div id="daily-data-section" class="section">
      <div class="container">
        <h1>ุจูุงูุงุช ุงูุชุณุฌูู ุงููููู</h1>
        
        <div class="info-box">
          <strong>ููุงุญุธุฉ:</strong> ููููู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุฃู ุงูุจุญุซ ูููุง.
        </div>
        
        <div class="toolbar">
          <input type="text" id="daily-data-search" placeholder="ุงุจุญุซ ูู ุงูุจูุงูุงุช..." style="flex:1">
          <button class="btn btn-primary" onclick="filterDailyData()">๐ ุจุญุซ</button>
          <button class="btn btn-secondary" onclick="exportDailyData()">๐ค ุชุตุฏูุฑ ุงููู</button>
          <button class="btn btn-info" onclick="loadDailyData()">๐ ุชุญุฏูุซ</button>
        </div>
        
        <div class="info-box">
          <strong>ุนุฏุฏ ุงูุณุฌูุงุช:</strong> <span id="daily-data-count">0</span> | 
          <strong>ุขุฎุฑ ุชุญุฏูุซ:</strong> <span id="daily-last-update">ุบูุฑ ูุนุฑูู</span>
        </div>
        
        <div style="overflow-x: auto; max-height: 500px;">
          <table class="excel-style" id="saved-daily-table">
            <thead>
              <tr id="daily-data-header"></tr>
            </thead>
            <tbody id="saved-daily-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ูุณู ุนุฑุถ ุงูุจูุงูุงุช -->
    <div id="data-section" class="section">
      <div class="container">
        <h1>ุงูุจูุงูุงุช ุงููุญููุธุฉ</h1>
        
        <div class="info-box">
          <strong>ููุงุญุธุฉ:</strong> ููููู ุงูุชุนุฏูู ุฃู ุงูุญุฐู ูุจุงุดุฑุฉ ูู ููุง. ุนูุฏ ุงูุชุนุฏูู ุณูุชู ููู ุงูุณุฌู ุฅูู ุดุงุดุฉ ุงูุชุฌููุน.
        </div>
        
        <div class="toolbar">
          <input type="text" id="data-search" placeholder="ุงุจุญุซ ูู ุงูุจูุงูุงุช..." style="flex:1">
          <button class="btn btn-primary" onclick="filterData()">๐ ุจุญุซ</button>
          <button class="btn btn-secondary" onclick="exportAllData()">๐ค ุชุตุฏูุฑ ุงููู</button>
          <button class="btn btn-info" onclick="loadSavedData()">๐ ุชุญุฏูุซ</button>
        </div>
        
        <div class="info-box">
          <strong>ุนุฏุฏ ุงูุณุฌูุงุช:</strong> <span id="data-count">0</span> | 
          <strong>ุขุฎุฑ ุชุญุฏูุซ:</strong> <span id="last-update">ุบูุฑ ูุนุฑูู</span>
        </div>
        
        <div style="overflow-x: auto; max-height: 500px;">
          <table class="excel-style" id="saved-data-table">
            <thead>
              <tr id="data-header"></tr>
            </thead>
            <tbody id="saved-data-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงููุดุฑููู -->
    <div id="supervisors-section" class="section">
      <div class="container">
        <h1>ุฅุฏุงุฑุฉ ุฃุณูุงุก ูุดุฑูู ุงูุฎุทูุท</h1>
        <div class="product-form">
          <div class="form-group">
            <label>ุงุณู ุงููุดุฑู</label>
            <input type="text" id="supervisor-name-input" class="form-control" placeholder="ูุซุงู: ูุญูุฏ ุฃุญูุฏ">
          </div>
          <button class="btn btn-success" onclick="addSupervisor()">โ ุฅุถุงูุฉ ูุดุฑู</button>
        </div>
        <table class="excel-style">
          <thead><tr><th>ุงุณู ุงููุดุฑู</th><th>ุงูุฅุฌุฑุงุกุงุช</th></tr></thead>
          <tbody id="supervisors-list"></tbody>
        </table>
      </div>
    </div>

    <!-- ุดุงุดุฉ ุงูุฃููุงุฏ ุงูุซุงุจุชุฉ -->
    <div id="fixedcodes-section" class="section">
      <div class="container">
        <h1>ุฅุฏุงุฑุฉ ุงูุฃููุงุฏ ุงูุซุงุจุชุฉ</h1>
        <div class="product-form">
          <div class="form-group">
            <label>ุฃุฏุฎู ููุฏ ุฌุฏูุฏ</label>
            <input type="text" id="fixed-code-input" class="form-control" placeholder="ูุซุงู: FC-005">
          </div>
          <button class="btn btn-success" onclick="addFixedCode()">โ ุฅุถุงูุฉ ุงูููุฏ</button>
        </div>
        <table class="excel-style">
          <thead>
            <tr><th>ุงูููุฏ</th><th>ุงูุฅุฌุฑุงุกุงุช</th></tr>
          </thead>
          <tbody id="fixed-codes-list"></tbody>
        </table>
      </div>
    </div>

    <!-- ูุณู ุงูุชูุงุฑูุฑ -->
    <div id="reports-section" class="section">
      <div class="container">
        <h1>ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</h1>
        <div class="toolbar">
          <button class="btn btn-primary" onclick="generateReports()">๐ ุชุญุฏูุซ ุงูุชูุงุฑูุฑ</button>
          <button class="btn btn-success" onclick="exportReports()">๐ ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ</button>
        </div>
        
        <div id="reports-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
          <!-- ุณูุชู ููุคู ุฏููุงููููุงู -->
        </div>

        <div class="toolbar" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px;">
          <button class="btn btn-warning" onclick="backupData()" style="color: #212529;">๐พ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
          <label for="restore-file" class="btn btn-danger" style="margin: 0;">
            ๐ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
          </label>
          <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreData(event)">
        </div>
      </div>
    </div>
  </div>

<script>
// ุงูุจูุงูุงุช ุงูุนุงูุฉ
const fixedCodes = ["FC-001", "FC-002", "FC-003", "FC-004"];
const fieldNames = [
  "ุงูุชุงุฑูุฎ","ุงูุงุณุจูุน","ุงููุฏูุฉ","ุฑูู ุงูุฎุท","ุฑูู ุงูุงุฒู","ููุฏ","ุงููุฌููุนุฉ","ุงุณู ุงูุตูู","ห","ห",
  "ููุน ุงูุบุทุงุก","ููุน ุงูุนูุจุฉ","ููู ุงูุนูุจุฉ","ููู ุงูุบุทุง","ุงูุงุชุฌุงุฉ","ุงูุฅูุชุงุฌูุฉ","ุฎุชู ุงูุจุทุงุฑูุฉ","ููุน ุงูุจููุงุช ุงููุณุชุฎุฏูู",
  "ููุงุญุธุงุช ุจููุงุช","ุงูุจููุงุช ุงููุตุฑููุฉ (+)","ุงูุจููุงุช ุงููุตุฑููุฉ (-)","ุงูุจููุงุช ุงููุณุชุฎุฏูู (+)","ุงูุจููุงุช ุงููุณุชุฎุฏูู (-)",
  "ุงูุบุทุงุก 1(ุงููุณุชุฎุฏู)","ุงูุนูุจุฉ (ุงููุณุชุฎุฏู)","ุงูุจููุงุช (ุงููุงูู)","ูุงูู ุฎุฑุฏู+","ูุงูู ุฎุฑุฏู -","ูุงูู ุชูููุฑ+","ูุงูู ุชูููุฑ-",
  "ุฎูุงูุง ุชุญุช ุงูุชูููุฑ","ุจุทุงุฑูุงุช ุชุญุช ุงูุชูููุฑ","ูุงูู ุงูุนุงุฒู (ุนุฏุฏ)",
  "ุงูุบุทุงุก 1(ุงููุงูู)","ุฏููุฉ ุบุทุง","ุนูุจ ุชุฎููุด","ุชุณููุญ ุบุทุง","ุนูุจ ูุงุฑุฏ ุบุทุง","ุชูููุฑ ุบุทุงุก",
  "ุงูุนูุจุฉ (ุงููุงูู)","ุฏููุฉ ุนูุจ","ุนูุจ ูุงุฑุฏ ุนูุจ","ุฑูุฌู","ุนูุจ ุชุฎุฑูู","ูุจุณูู","ุชุณููุญ ุนูุจ","ุชูููุฑ ุนูุจ",
  "ูุฑุงูุจ ุงูุงูุชุงุฌ","ูุดุฑู ุงูุฎุท","ููุฏ ุงูุนูุจ","ููุฏ ุงูุบุทุง",
  "ุงูุนูุจ ุงููุตุฑููุฉ",
  "ุงูุบุทุง ุงููุตุฑูู",
  "ุงูููุฏ ุซุงุจุช"
];

// ุชููุฆุฉ ุงูุชุฎุฒูู ุงููุญูู
let entries = JSON.parse(localStorage.getItem("batteryData") || "[]");
let tempEntries = []; // ุจูุงูุงุช ูุคูุชุฉ ูุจู ุงูุญูุธ
let products = JSON.parse(localStorage.getItem("products") || "[]");
let groups = JSON.parse(localStorage.getItem("groups") || "[]");
let lines = JSON.parse(localStorage.getItem("lines") || "[]");
let inventory = JSON.parse(localStorage.getItem("inventory") || "[]");
let currentProductId = 2000000;
let editingProductId = null;
let editingGroupId = null;
let editingLineId = null;
let selectedCell = null;
let selectedRowIndex = -1;
let isEditingMode = false;
let editingIndex = -1;

// ูุชุบูุฑุงุช ุงูุชุณุฌูู ุงููููู
let dailyEntries = JSON.parse(localStorage.getItem("dailyData") || "[]");
let tempDailyEntries = [];
const dailyFieldNames = [
  "ุงูุชุงุฑูุฎ", "ุงููุฑุฏูุฉ", "ุฑูู ุงูุฎุท", "ุฑูู ุงูุงุฒู", "ููุน ุงูุนูููุฉ",
  "ููุฏ ุงูุตูู", "ุงููุฌููุนุฉ", "ุงุณู ุงูุตูู", "ุงูุชูููู +", "ุงูุชูููู -",
  "ููุน ุงูุบุทุง", "ููุน ุงูุนูุจุฉ", "ููู ุงูุนูุจุฉ", "ููู ุงูุบุทุง", "ุงูุงุชุฌุงุฉ",
  "ุงููููุฉ"
];
let selectedDailyCell = null;
let selectedDailyRowIndex = -1;

// ===== ูุธุงู ุงููุตุงุฏูุฉ =====
const users = JSON.parse(localStorage.getItem('erpUsers') || '[]');
let currentUser = null;

// ุฅุฐุง ูู ููู ููุงู ูุณุชุฎุฏูููุ ูุถูู ูุณุชุฎุฏู ุงูุชุฑุงุถู
if (users.length === 0) {
  users.push({
    id: 1,
    username: 'admin',
    password: 'admin123',
    name: 'ุงููุฏูุฑ ุงูุนุงู',
    role: 'admin'
  });
  localStorage.setItem('erpUsers', JSON.stringify(users));
}

function showLoginForm() {
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('main-sections').style.display = 'none';
  document.getElementById('login-username').focus();
}

function login() {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    currentUser = user;
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-sections').style.display = 'block';
    document.getElementById('user-info').textContent = `ูุฑุญุจุงู ${user.name}`;
    initPage();
  } else {
    alert('ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ');
  }
}

function logout() {
  currentUser = null;
  showLoginForm();
}

// ===== ุฏูุงู ุดุงุดุฉ ุงูุชุฌููุน =====
function createExcelTable() {
  const headerRow = document.getElementById("header-row");
  headerRow.innerHTML = "";
  
  fieldNames.forEach(field => {
    const th = document.createElement("th");
    th.textContent = field;
    headerRow.appendChild(th);
  });
  
  loadDataIntoTable();
  
  if (tempEntries.length === 0) {
    addNewRow();
  }
}

function loadDataIntoTable() {
  const tbody = document.getElementById("data-body");
  tbody.innerHTML = "";
  
  tempEntries.forEach((entry, rowIndex) => {
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = rowIndex;
    
    fieldNames.forEach((field, colIndex) => {
      const td = document.createElement("td");
      td.dataset.field = field;
      
      if (field === "ุงูุชุงุฑูุฎ") {
        const input = document.createElement("input");
        input.type = "date";
        input.value = entry[field] || new Date().toISOString().split('T')[0];
        input.addEventListener("change", () => updateCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else if (field === "ุงููุฏูุฉ") {
        const select = document.createElement("select");
        ["1", "2", "3"].forEach(num => {
          const option = document.createElement("option");
          option.value = num;
          option.textContent = num;
          select.appendChild(option);
        });
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "ููุฏ") {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.className = "code-input";
        input.addEventListener("blur", function() {
          const productId = this.value.trim();
          if (!productId) return;
          
          const product = products.find(p => p.id == productId);
          if (product) {
            fillProductData(tr, product);
          }
        });
        input.addEventListener("change", () => updateCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.addEventListener("change", () => updateCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      
      td.addEventListener("click", function() {
        selectCell(this, rowIndex);
      });
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

function fillProductData(row, product) {
  const fieldsToFill = {
    "ุงููุฌููุนุฉ": product.group || '',
    "ุงุณู ุงูุตูู": product.name,
    "ห": product.plus || '',
    "ห": product.minus || '',
    "ููุน ุงูุบุทุงุก": product.coverType || '',
    "ููุน ุงูุนูุจุฉ": product.boxType || '',
    "ููู ุงูุนูุจุฉ": product.boxColor || '',
    "ููู ุงูุบุทุง": product.coverColor || '',
    "ุงูุงุชุฌุงุฉ": product.direction || '',
    "ููุฏ ุงูุนูุจ": product.boxCode || '',
    "ููุฏ ุงูุบุทุง": product.coverCode || ''
  };
  
  Object.entries(fieldsToFill).forEach(([field, value]) => {
    const input = row.querySelector(`[data-field="${field}"] input`);
    if (input) {
      input.value = value;
      updateCellValue(row.dataset.rowIndex, field, value);
    }
  });
}

function updateCellValue(rowIndex, field, value) {
  if (!tempEntries[rowIndex]) tempEntries[rowIndex] = {};
  tempEntries[rowIndex][field] = value;
}

function addNewRow() {
  const newRow = {};
  newRow["ุงูุชุงุฑูุฎ"] = new Date().toISOString().split('T')[0];
  tempEntries.push(newRow);
  loadDataIntoTable();
  
  const newRowIndex = tempEntries.length - 1;
  const newRowElement = document.querySelector(`#data-body tr[data-row-index="${newRowIndex}"]`);
  if (newRowElement) {
    const firstInput = newRowElement.querySelector("td:first-child input");
    if (firstInput) firstInput.focus();
  }
}

function deleteRow(rowIndex) {
  tempEntries.splice(rowIndex, 1);
  loadDataIntoTable();
}

function deleteSelectedRow() {
  if (selectedRowIndex >= 0) {
    deleteRow(selectedRowIndex);
  } else {
    alert("ุงูุฑุฌุงุก ุชุญุฏูุฏ ุตู ูุญุฐูู");
  }
}

function saveAssemblyData() {
  if (tempEntries.length === 0) {
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุญูุธ");
    return;
  }
  
  entries = [...entries, ...tempEntries];
  localStorage.setItem("batteryData", JSON.stringify(entries));
  localStorage.setItem("lastUpdate", new Date().toLocaleString("ar-EG"));
  
  tempEntries = [];
  loadDataIntoTable();
  
  const messageEl = document.getElementById('save-message');
  messageEl.textContent = `ุชู ุญูุธ ${entries.length} ุณุฌู ุจูุฌุงุญ`;
  messageEl.style.display = 'block';
  setTimeout(() => messageEl.style.display = 'none', 3000);
}

function selectCell(cell, rowIndex) {
  if (selectedCell) {
    selectedCell.classList.remove("selected-cell");
  }
  selectedCell = cell;
  selectedRowIndex = rowIndex;
  cell.classList.add("selected-cell");
  
  const input = cell.querySelector("input, select");
  if (input) input.focus();
}

// ===== ุฏูุงู ุดุงุดุฉ ุงูุชุณุฌูู ุงููููู =====
function createDailyTable() {
  const headerRow = document.getElementById("daily-header-row");
  headerRow.innerHTML = "";
  
  dailyFieldNames.forEach(field => {
    const th = document.createElement("th");
    th.textContent = field;
    headerRow.appendChild(th);
  });
  
  loadDailyDataIntoTable();
  
  if (tempDailyEntries.length === 0) {
    addNewDailyRow();
  }
}

function loadDailyDataIntoTable() {
  const tbody = document.getElementById("daily-data-body");
  tbody.innerHTML = "";
  
  tempDailyEntries.forEach((entry, rowIndex) => {
    const tr = document.createElement("tr");
    tr.dataset.rowIndex = rowIndex;
    
    dailyFieldNames.forEach((field, colIndex) => {
      const td = document.createElement("td");
      td.dataset.field = field;
      
      if (field === "ุงูุชุงุฑูุฎ") {
        const input = document.createElement("input");
        input.type = "date";
        input.value = entry[field] || new Date().toISOString().split('T')[0];
        input.addEventListener("change", () => updateDailyCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else if (field === "ุงููุฑุฏูุฉ") {
        const select = document.createElement("select");
        ["1", "2", "3"].forEach(num => {
          const option = document.createElement("option");
          option.value = num;
          option.textContent = num;
          select.appendChild(option);
        });
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateDailyCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "ุฑูู ุงูุฎุท") {
        const select = document.createElement("select");
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = "ุงุฎุชุฑ ุฎุทุงู...";
        select.appendChild(emptyOption);
        
        lines.forEach(line => {
          const option = document.createElement("option");
          option.value = line.number;
          option.textContent = `${line.number} - ${line.name || 'ุจุฏูู ุงุณู'}`;
          select.appendChild(option);
        });
        
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateDailyCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "ููุน ุงูุนูููุฉ") {
        const select = document.createElement("select");
        ["ุฅุถุงูุฉ", "ุตุฑู", "ุงุฑุชุฌุงุน", "ุชุญููู"].forEach(type => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          select.appendChild(option);
        });
        select.value = entry[field] || "";
        select.addEventListener("change", () => updateDailyCellValue(rowIndex, field, select.value));
        td.appendChild(select);
      }
      else if (field === "ููุฏ ุงูุตูู") {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.className = "code-input";
        input.addEventListener("blur", function() {
          const productId = this.value.trim();
          if (!productId) return;
          
          const product = products.find(p => p.id == productId);
          if (product) {
            fillDailyProductData(tr, product);
          }
        });
        input.addEventListener("change", () => updateDailyCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else if (field === "ุงููููุฉ") {
        const input = document.createElement("input");
        input.type = "number";
        input.value = entry[field] || "";
        input.addEventListener("change", () => updateDailyCellValue(rowIndex, field, input.value));
        td.appendChild(input);
      }
      else {
        const input = document.createElement("input");
        input.type = "text";
        input.value = entry[field] || "";
        input.readOnly = true;
        input.className = "read-only-cell";
        td.appendChild(input);
      }
      
      td.addEventListener("click", function() {
        selectDailyCell(this, rowIndex);
      });
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
}

function fillDailyProductData(row, product) {
  const fieldsToFill = {
    "ุงููุฌููุนุฉ": product.group || '',
    "ุงุณู ุงูุตูู": product.name,
    "ุงูุชูููู +": product.plus || '',
    "ุงูุชูููู -": product.minus || '',
    "ููุน ุงูุบุทุง": product.coverType || '',
    "ููุน ุงูุนูุจุฉ": product.boxType || '',
    "ููู ุงูุนูุจุฉ": product.boxColor || '',
    "ููู ุงูุบุทุง": product.coverColor || '',
    "ุงูุงุชุฌุงุฉ": product.direction || ''
  };
  
  Object.entries(fieldsToFill).forEach(([field, value]) => {
    const input = row.querySelector(`[data-field="${field}"] input`);
    if (input) {
      input.value = value;
      updateDailyCellValue(row.dataset.rowIndex, field, value);
    }
  });
}

function updateDailyCellValue(rowIndex, field, value) {
  if (!tempDailyEntries[rowIndex]) tempDailyEntries[rowIndex] = {};
  tempDailyEntries[rowIndex][field] = value;
}

function addNewDailyRow() {
  const newRow = {};
  newRow["ุงูุชุงุฑูุฎ"] = new Date().toISOString().split('T')[0];
  tempDailyEntries.push(newRow);
  loadDailyDataIntoTable();
  
  const newRowIndex = tempDailyEntries.length - 1;
  const newRowElement = document.querySelector(`#daily-data-body tr[data-row-index="${newRowIndex}"]`);
  if (newRowElement) {
    const firstInput = newRowElement.querySelector("td:first-child input");
    if (firstInput) firstInput.focus();
  }
}

function deleteDailyRow(rowIndex) {
  tempDailyEntries.splice(rowIndex, 1);
  loadDailyDataIntoTable();
}

function deleteSelectedDailyRow() {
  if (selectedDailyRowIndex >= 0) {
    deleteDailyRow(selectedDailyRowIndex);
  } else {
    alert("ุงูุฑุฌุงุก ุชุญุฏูุฏ ุตู ูุญุฐูู");
  }
}

function saveDailyData() {
  if (tempDailyEntries.length === 0) {
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุญูุธ");
    return;
  }
  
  // ุชุญุฏูุซ ุงููุฎุฒูู ุจูุงุก ุนูู ููุน ุงูุนูููุฉ
  tempDailyEntries.forEach(entry => {
    const productId = entry["ููุฏ ุงูุตูู"];
    const quantity = parseFloat(entry["ุงููููุฉ"]) || 0;
    const operation = entry["ููุน ุงูุนูููุฉ"];
    
    if (!productId) return;
    
    const inventoryItem = inventory.find(item => item.productId == productId);
    if (!inventoryItem) return;
    
    switch(operation) {
      case "ุฅุถุงูุฉ":
        inventoryItem.quantity += quantity;
        break;
      case "ุตุฑู":
        inventoryItem.quantity -= quantity;
        break;
      case "ุงุฑุชุฌุงุน":
        inventoryItem.quantity += quantity;
        break;
      case "ุชุญููู":
        // ูููู ุฅุถุงูุฉ ููุทู ุฎุงุต ุจุงูุชุญููู ุฅุฐุง ูุฒู ุงูุฃูุฑ
        break;
    }
    
    inventoryItem.lastUpdated = new Date().toLocaleString("ar-EG");
  });
  
  // ุญูุธ ุงูุจูุงูุงุช
  dailyEntries = [...dailyEntries, ...tempDailyEntries];
  localStorage.setItem("dailyData", JSON.stringify(dailyEntries));
  localStorage.setItem("inventory", JSON.stringify(inventory));
  localStorage.setItem("dailyLastUpdate", new Date().toLocaleString("ar-EG"));
  
  // ุฅูุฑุงุบ ุงูุจูุงูุงุช ุงููุคูุชุฉ
  tempDailyEntries = [];
  loadDailyDataIntoTable();
  
  // ุนุฑุถ ุฑุณุงูุฉ ุชุฃููุฏ
  const messageEl = document.getElementById('daily-save-message');
  messageEl.textContent = `ุชู ุญูุธ ${dailyEntries.length} ุณุฌู ุจูุฌุงุญ`;
  messageEl.style.display = 'block';
  setTimeout(() => messageEl.style.display = 'none', 3000);
  
  // ุชุญุฏูุซ ุดุงุดุฉ ุงูุฑุตูุฏ
  renderInventoryTable();
}

function loadDailyData() {
  dailyEntries = JSON.parse(localStorage.getItem("dailyData") || "[]");
  const headerRow = document.getElementById("daily-data-header");
  const dataBody = document.getElementById("saved-daily-body");
  
  document.getElementById("daily-data-count").textContent = dailyEntries.length;
  document.getElementById("daily-last-update").textContent = 
    localStorage.getItem("dailyLastUpdate") || "ุบูุฑ ูุนุฑูู";
  
  headerRow.innerHTML = "";
  if (dailyEntries.length > 0) {
    dailyFieldNames.forEach(field => {
      const th = document.createElement("th");
      th.textContent = field;
      headerRow.appendChild(th);
    });
    
    const actionTh = document.createElement("th");
    actionTh.textContent = "ุงูุฅุฌุฑุงุกุงุช";
    headerRow.appendChild(actionTh);
  }
  
  dataBody.innerHTML = "";
  dailyEntries.forEach((entry, index) => {
    const tr = document.createElement("tr");
    tr.dataset.index = index;
    
    dailyFieldNames.forEach(field => {
      const td = document.createElement("td");
      td.textContent = entry[field] || "-";
      tr.appendChild(td);
    });
    
    const actionTd = document.createElement("td");
    actionTd.innerHTML = `
      <button class="btn btn-danger" onclick="deleteDailyEntry(${index})">๐๏ธ ุญุฐู</button>
    `;
    tr.appendChild(actionTd);
    
    dataBody.appendChild(tr);
  });
}

function deleteDailyEntry(index) {
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ")) {
    dailyEntries.splice(index, 1);
    localStorage.setItem("dailyData", JSON.stringify(dailyEntries));
    loadDailyData();
  }
}

function exportDailyData() {
  if (dailyEntries.length === 0) {
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ููุชุตุฏูุฑ");
    return;
  }
  
  const csvContent = [
    dailyFieldNames.join(","),
    ...dailyEntries.map(item => dailyFieldNames.map(field => item[field] || "").join(","))
  ].join("\n");
  
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ุจูุงูุงุช_ุงูุชุณุฌูู_ุงููููู_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
}

function filterDailyData() {
  const searchTerm = document.getElementById("daily-data-search").value.toLowerCase();
  const rows = document.querySelectorAll("#saved-daily-body tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

function selectDailyCell(cell, rowIndex) {
  if (selectedDailyCell) {
    selectedDailyCell.classList.remove("selected-cell");
  }
  selectedDailyCell = cell;
  selectedDailyRowIndex = rowIndex;
  cell.classList.add("selected-cell");
  
  const input = cell.querySelector("input, select");
  if (input) input.focus();
}

// ===== ุฏูุงู ุดุงุดุฉ ุงูุฃุตูุงู =====
function updateAutoCode() {
  currentProductId = products.length > 0 ? 
    Math.max(...products.map(p => parseInt(p.id))) + 1 : 
    2000000;
  document.getElementById("auto-code").textContent = currentProductId;
}

function addProduct() {
  const name = document.getElementById("product-name").value.trim();
  const group = document.getElementById("product-group").value;
  
  if (!name || !group) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูุตูู ูุงุฎุชูุงุฑ ูุฌููุนุฉ");
    return;
  }
  
  const product = {
    id: editingProductId || currentProductId.toString(),
    name,
    group,
    coverType: document.getElementById("cover-type").value,
    boxType: document.getElementById("box-type").value,
    boxColor: document.getElementById("box-color").value,
    coverColor: document.getElementById("cover-color").value,
    direction: document.getElementById("direction").value,
    plus: document.getElementById("product-plus").value,
    minus: document.getElementById("product-minus").value,
    notes: document.getElementById("product-notes").value,
    boxCode: document.getElementById("box-code").value,
    coverCode: document.getElementById("cover-code").value
  };
  
  if (editingProductId) {
    // ุชุญุฏูุซ ุงูุตูู ุงูููุฌูุฏ
    const index = products.findIndex(p => p.id == editingProductId);
    if (index !== -1) {
      products[index] = product;
    }
    editingProductId = null;
    document.getElementById("product-action-btn").textContent = "โ ุฅุถุงูุฉ ุตูู";
    document.getElementById("cancel-edit-btn").style.display = "none";
    document.getElementById("form-title").textContent = "ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ";
  } else {
    // ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ
    products.push(product);
    
    // ุฅุถุงูุฉ ุฅูู ุงููุฎุฒูู
    inventory.push({
      productId: product.id,
      productName: product.name,
      group: product.group,
      quantity: 0,
      lastUpdated: new Date().toLocaleString("ar-EG"),
      plus: product.plus,
      minus: product.minus,
      boxColor: product.boxColor,
      coverColor: product.coverColor,
      boxType: product.boxType,
      coverType: product.coverType,
      direction: product.direction
    });
    
    currentProductId++;
  }
  
  localStorage.setItem("products", JSON.stringify(products));
  localStorage.setItem("inventory", JSON.stringify(inventory));
  renderProductsTable();
  renderInventoryTable();
  updateAutoCode();
  resetProductForm();
}

function editProduct(productId) {
  const product = products.find(p => p.id == productId);
  if (!product) return;
  
  editingProductId = productId;
  document.getElementById("product-name").value = product.name;
  document.getElementById("product-group").value = product.group;
  document.getElementById("cover-type").value = product.coverType || "";
  document.getElementById("box-type").value = product.boxType || "";
  document.getElementById("box-color").value = product.boxColor || "";
  document.getElementById("cover-color").value = product.coverColor || "";
  document.getElementById("direction").value = product.direction || "";
  document.getElementById("product-plus").value = product.plus || "";
  document.getElementById("product-minus").value = product.minus || "";
  document.getElementById("product-notes").value = product.notes || "";
  document.getElementById("box-code").value = product.boxCode || "";
  document.getElementById("cover-code").value = product.coverCode || "";
  
  document.getElementById("auto-code").textContent = productId;
  document.getElementById("product-action-btn").textContent = "๐พ ุญูุธ ุงูุชุนุฏููุงุช";
  document.getElementById("cancel-edit-btn").style.display = "inline-block";
  document.getElementById("form-title").textContent = "ุชุนุฏูู ุตูู";
}

function deleteProduct(productId) {
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุตููุ")) {
    products = products.filter(p => p.id != productId);
    inventory = inventory.filter(i => i.productId != productId);
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("inventory", JSON.stringify(inventory));
    renderProductsTable();
    renderInventoryTable();
    updateAutoCode();
  }
}

function resetProductForm() {
  document.getElementById("product-name").value = "";
  document.getElementById("product-group").value = "";
  document.getElementById("cover-type").value = "";
  document.getElementById("box-type").value = "";
  document.getElementById("box-color").value = "";
  document.getElementById("cover-color").value = "";
  document.getElementById("direction").value = "";
  document.getElementById("product-plus").value = "";
  document.getElementById("product-minus").value = "";
  document.getElementById("product-notes").value = "";
  document.getElementById("box-code").value = "";
  document.getElementById("cover-code").value = "";
  updateAutoCode();
}

function cancelEdit() {
  editingProductId = null;
  document.getElementById("product-action-btn").textContent = "โ ุฅุถุงูุฉ ุตูู";
  document.getElementById("cancel-edit-btn").style.display = "none";
  document.getElementById("form-title").textContent = "ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ";
  resetProductForm();
}

function renderProductsTable() {
  const tbody = document.getElementById("products-list");
  tbody.innerHTML = "";
  
  products.forEach(product => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${product.id}</td>
      <td>${product.name}</td>
      <td>${product.group}</td>
      <td>${product.coverType || '-'}</td>
      <td>${product.boxType || '-'}</td>
      <td>${product.boxColor || '-'}</td>
      <td>${product.coverColor || '-'}</td>
      <td>${product.direction || '-'}</td>
      <td>${product.plus || '-'}</td>
      <td>${product.minus || '-'}</td>
      <td>${product.notes || '-'}</td>
      <td>${product.boxCode || '-'}</td>
      <td>${product.coverCode || '-'}</td>
      <td class="action-btns">
        <button class="btn-add" onclick="editProduct('${product.id}')">โ๏ธ ุชุนุฏูู</button>
        <button class="btn-remove" onclick="deleteProduct('${product.id}')">๐๏ธ ุญุฐู</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function searchProducts() {
  const searchTerm = document.getElementById("product-search").value.toLowerCase();
  const rows = document.querySelectorAll("#products-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

function updateGroupsDropdown() {
  const select = document.getElementById("product-group");
  select.innerHTML = '<option value="">ุงุฎุชุฑ ูุฌููุนุฉ...</option>';
  
  groups.forEach(group => {
    const option = document.createElement("option");
    option.value = group.name;
    option.textContent = group.name;
    select.appendChild(option);
  });
}

// ===== ุฏูุงู ุดุงุดุฉ ุงูุฑุตูุฏ =====
function renderInventoryTable() {
  const tbody = document.getElementById("inventory-list");
  tbody.innerHTML = "";
  
  inventory.forEach(item => {
    const product = products.find(p => p.id == item.productId) || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.productId}</td>
      <td>${item.group || product.group || '-'}</td>
      <td>${item.productName || product.name || '-'}</td>
      <td>${item.plus || product.plus || '-'}</td>
      <td>${item.minus || product.minus || '-'}</td>
      <td>${item.boxColor || product.boxColor || '-'}</td>
      <td>${item.coverColor || product.coverColor || '-'}</td>
      <td>${item.boxType || product.boxType || '-'}</td>
      <td>${item.coverType || product.coverType || '-'}</td>
      <td>${item.direction || product.direction || '-'}</td>
      <td><input type="number" value="${item.quantity || 0}" onchange="updateInventoryQuantity('${item.productId}', this.value)"></td>
      <td>${item.lastUpdated || '-'}</td>
      <td>
        <button class="btn btn-info" onclick="updateInventoryItem('${item.productId}')">๐ ุชุญุฏูุซ</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function updateInventoryQuantity(productId, quantity) {
  const item = inventory.find(i => i.productId == productId);
  if (item) {
    item.quantity = parseFloat(quantity) || 0;
    item.lastUpdated = new Date().toLocaleString("ar-EG");
    localStorage.setItem("inventory", JSON.stringify(inventory));
  }
}

function updateInventoryItem(productId) {
  const item = inventory.find(i => i.productId == productId);
  const product = products.find(p => p.id == productId);
  
  if (item && product) {
    item.productName = product.name;
    item.group = product.group;
    item.plus = product.plus;
    item.minus = product.minus;
    item.boxColor = product.boxColor;
    item.coverColor = product.coverColor;
    item.boxType = product.boxType;
    item.coverType = product.coverType;
    item.direction = product.direction;
    item.lastUpdated = new Date().toLocaleString("ar-EG");
    
    localStorage.setItem("inventory", JSON.stringify(inventory));
    renderInventoryTable();
  }
}

function updateAllInventory() {
  inventory.forEach(item => {
    const product = products.find(p => p.id == item.productId);
    if (product) {
      item.productName = product.name;
      item.group = product.group;
      item.plus = product.plus;
      item.minus = product.minus;
      item.boxColor = product.boxColor;
      item.coverColor = product.coverColor;
      item.boxType = product.boxType;
      item.coverType = product.coverType;
      item.direction = product.direction;
      item.lastUpdated = new Date().toLocaleString("ar-EG");
    }
  });
  
  localStorage.setItem("inventory", JSON.stringify(inventory));
  renderInventoryTable();
  alert("ุชู ุชุญุฏูุซ ุฌููุน ุงูุฃุตูุงู ูู ุงููุฎุฒูู");
}

function searchInventory() {
  const searchTerm = document.getElementById("inventory-search").value.toLowerCase();
  const rows = document.querySelectorAll("#inventory-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

// ===== ุฏูุงู ุดุงุดุฉ ุงููุฌููุนุงุช =====
function addGroup() {
  const name = document.getElementById("group-name").value.trim();
  
  if (!name) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุฌููุนุฉ");
    return;
  }
  
  const group = {
    id: editingGroupId || Date.now().toString(),
    name,
    notes: document.getElementById("group-notes").value
  };
  
  if (editingGroupId) {
    // ุชุญุฏูุซ ุงููุฌููุนุฉ ุงูููุฌูุฏุฉ
    const index = groups.findIndex(g => g.id == editingGroupId);
    if (index !== -1) {
      groups[index] = group;
    }
    editingGroupId = null;
    document.getElementById("group-action-btn").textContent = "โ ุฅุถุงูุฉ ูุฌููุนุฉ";
    document.getElementById("cancel-group-edit-btn").style.display = "none";
    document.getElementById("group-form-title").textContent = "ุฅุถุงูุฉ ูุฌููุนุฉ ุฌุฏูุฏุฉ";
  } else {
    // ุฅุถุงูุฉ ูุฌููุนุฉ ุฌุฏูุฏุฉ
    groups.push(group);
  }
  
  localStorage.setItem("groups", JSON.stringify(groups));
  renderGroupsTable();
  updateGroupsDropdown();
  resetGroupForm();
}

function editGroup(groupId) {
  const group = groups.find(g => g.id == groupId);
  if (!group) return;
  
  editingGroupId = groupId;
  document.getElementById("group-name").value = group.name;
  document.getElementById("group-notes").value = group.notes || "";
  
  document.getElementById("group-action-btn").textContent = "๐พ ุญูุธ ุงูุชุนุฏููุงุช";
  document.getElementById("cancel-group-edit-btn").style.display = "inline-block";
  document.getElementById("group-form-title").textContent = "ุชุนุฏูู ูุฌููุนุฉ";
}

function deleteGroup(groupId) {
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุฌููุนุฉุ ุณูุชู ุฅุฒุงูุฉ ุงุฑุชุจุงุทูุง ุจุงูุฃุตูุงู.")) {
    groups = groups.filter(g => g.id != groupId);
    
    // ุฅุฒุงูุฉ ุงููุฌููุนุฉ ูู ุงูุฃุตูุงู ุงููุฑุชุจุทุฉ ุจูุง
    products.forEach(product => {
      if (product.group === groupId) {
        product.group = "";
      }
    });
    
    localStorage.setItem("groups", JSON.stringify(groups));
    localStorage.setItem("products", JSON.stringify(products));
    renderGroupsTable();
    updateGroupsDropdown();
    renderProductsTable();
  }
}

function resetGroupForm() {
  document.getElementById("group-name").value = "";
  document.getElementById("group-notes").value = "";
}

function cancelGroupEdit() {
  editingGroupId = null;
  document.getElementById("group-action-btn").textContent = "โ ุฅุถุงูุฉ ูุฌููุนุฉ";
  document.getElementById("cancel-group-edit-btn").style.display = "none";
  document.getElementById("group-form-title").textContent = "ุฅุถุงูุฉ ูุฌููุนุฉ ุฌุฏูุฏุฉ";
  resetGroupForm();
}

function renderGroupsTable() {
  const tbody = document.getElementById("groups-list");
  tbody.innerHTML = "";
  
  groups.forEach(group => {
    const productCount = products.filter(p => p.group === group.name).length;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${group.name}</td>
      <td>${productCount}</td>
      <td>${group.notes || '-'}</td>
      <td class="action-btns">
        <button class="btn-add" onclick="editGroup('${group.id}')">โ๏ธ ุชุนุฏูู</button>
        <button class="btn-remove" onclick="deleteGroup('${group.id}')">๐๏ธ ุญุฐู</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function searchGroups() {
  const searchTerm = document.getElementById("group-search").value.toLowerCase();
  const rows = document.querySelectorAll("#groups-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

// ===== ุฏูุงู ุดุงุดุฉ ุงูุฎุทูุท =====
function addLine() {
  const number = document.getElementById("line-number").value.trim();
  const name = document.getElementById("line-name").value.trim();
  
  if (!number) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุงูุฎุท");
    return;
  }
  
  const line = {
    id: editingLineId || Date.now().toString(),
    number,
    name,
    location: document.getElementById("line-location").value,
    notes: document.getElementById("line-notes").value
  };
  
  if (editingLineId) {
    // ุชุญุฏูุซ ุงูุฎุท ุงูููุฌูุฏ
    const index = lines.findIndex(l => l.id == editingLineId);
    if (index !== -1) {
      lines[index] = line;
    }
    editingLineId = null;
    document.getElementById("line-action-btn").textContent = "โ ุฅุถุงูุฉ ุฎุท";
    document.getElementById("cancel-line-edit-btn").style.display = "none";
    document.getElementById("line-form-title").textContent = "ุฅุถุงูุฉ ุฎุท ุฌุฏูุฏ";
  } else {
    // ุฅุถุงูุฉ ุฎุท ุฌุฏูุฏ
    lines.push(line);
  }
  
  localStorage.setItem("lines", JSON.stringify(lines));
  renderLinesTable();
  resetLineForm();
}

function editLine(lineId) {
  const line = lines.find(l => l.id == lineId);
  if (!line) return;
  
  editingLineId = lineId;
  document.getElementById("line-number").value = line.number;
  document.getElementById("line-name").value = line.name || "";
  document.getElementById("line-location").value = line.location || "";
  document.getElementById("line-notes").value = line.notes || "";
  
  document.getElementById("line-action-btn").textContent = "๐พ ุญูุธ ุงูุชุนุฏููุงุช";
  document.getElementById("cancel-line-edit-btn").style.display = "inline-block";
  document.getElementById("line-form-title").textContent = "ุชุนุฏูู ุฎุท";
}

function deleteLine(lineId) {
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฎุทุ")) {
    lines = lines.filter(l => l.id != lineId);
    localStorage.setItem("lines", JSON.stringify(lines));
    renderLinesTable();
  }
}

function resetLineForm() {
  document.getElementById("line-number").value = "";
  document.getElementById("line-name").value = "";
  document.getElementById("line-location").value = "";
  document.getElementById("line-notes").value = "";
}

function cancelLineEdit() {
  editingLineId = null;
  document.getElementById("line-action-btn").textContent = "โ ุฅุถุงูุฉ ุฎุท";
  document.getElementById("cancel-line-edit-btn").style.display = "none";
  document.getElementById("line-form-title").textContent = "ุฅุถุงูุฉ ุฎุท ุฌุฏูุฏ";
  resetLineForm();
}

function renderLinesTable() {
  const tbody = document.getElementById("lines-list");
  tbody.innerHTML = "";
  
  lines.forEach(line => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${line.number}</td>
      <td>${line.name || '-'}</td>
      <td>${line.location || '-'}</td>
      <td>${line.notes || '-'}</td>
      <td class="action-btns">
        <button class="btn-add" onclick="editLine('${line.id}')">โ๏ธ ุชุนุฏูู</button>
        <button class="btn-remove" onclick="deleteLine('${line.id}')">๐๏ธ ุญุฐู</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function searchLines() {
  const searchTerm = document.getElementById("line-search").value.toLowerCase();
  const rows = document.querySelectorAll("#lines-list tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

// ===== ุฏูุงู ุนุฑุถ ุงูุจูุงูุงุช ุงููุญููุธุฉ =====
function loadSavedData() {
  entries = JSON.parse(localStorage.getItem("batteryData") || "[]");
  const headerRow = document.getElementById("data-header");
  const dataBody = document.getElementById("saved-data-body");
  
  document.getElementById("data-count").textContent = entries.length;
  document.getElementById("last-update").textContent = 
    localStorage.getItem("lastUpdate") || "ุบูุฑ ูุนุฑูู";
  
  headerRow.innerHTML = "";
  if (entries.length > 0) {
    fieldNames.forEach(field => {
      const th = document.createElement("th");
      th.textContent = field;
      headerRow.appendChild(th);
    });
    
    const actionTh = document.createElement("th");
    actionTh.textContent = "ุงูุฅุฌุฑุงุกุงุช";
    headerRow.appendChild(actionTh);
  }
  
  dataBody.innerHTML = "";
  entries.forEach((entry, index) => {
    const tr = document.createElement("tr");
    tr.dataset.index = index;
    
    fieldNames.forEach(field => {
      const td = document.createElement("td");
      td.textContent = entry[field] || "-";
      tr.appendChild(td);
    });
    
    const actionTd = document.createElement("td");
    actionTd.innerHTML = `
      <button class="btn btn-primary" onclick="editSavedEntry(${index})">โ๏ธ ุชุนุฏูู</button>
      <button class="btn btn-danger" onclick="deleteSavedEntry(${index})">๐๏ธ ุญุฐู</button>
    `;
    tr.appendChild(actionTd);
    
    dataBody.appendChild(tr);
  });
}

function editSavedEntry(index) {
  const entry = entries[index];
  if (!entry) return;
  
  // ููู ุงูุจูุงูุงุช ุฅูู ุดุงุดุฉ ุงูุชุฌููุน
  showSection('assembly-section');
  tempEntries = [entry];
  loadDataIntoTable();
  
  // ุญุฐู ุงูุณุฌู ุงููุฏูู
  entries.splice(index, 1);
  localStorage.setItem("batteryData", JSON.stringify(entries));
  loadSavedData();
}

function deleteSavedEntry(index) {
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ")) {
    entries.splice(index, 1);
    localStorage.setItem("batteryData", JSON.stringify(entries));
    loadSavedData();
  }
}

function filterData() {
  const searchTerm = document.getElementById("data-search").value.toLowerCase();
  const rows = document.querySelectorAll("#saved-data-body tr");
  
  rows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(searchTerm) ? "" : "none";
  });
}

function exportAllData() {
  if (entries.length === 0) {
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ููุชุตุฏูุฑ");
    return;
  }
  
  const csvContent = [
    fieldNames.join(","),
    ...entries.map(item => fieldNames.map(field => item[field] || "").join(","))
  ].join("\n");
  
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ุจูุงูุงุช_ุงูุชุฌููุน_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
}

// ===== ุฏูุงู ุดุงุดุฉ ุงููุดุฑููู =====
function addSupervisor() {
  const name = document.getElementById("supervisor-name-input").value.trim();
  if (!name) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุดุฑู");
    return;
  }
  
  // ุญูุธ ุงููุดุฑู ูู localStorage
  const supervisors = JSON.parse(localStorage.getItem("supervisors") || []);
  supervisors.push(name);
  localStorage.setItem("supervisors", JSON.stringify(supervisors));
  
  // ุชุญุฏูุซ ุงููุงุฆูุฉ
  renderSupervisorsList();
  
  // ูุณุญ ุญูู ุงูุฅุฏุฎุงู
  document.getElementById("supervisor-name-input").value = "";
}

function deleteSupervisor(index) {
  const supervisors = JSON.parse(localStorage.getItem("supervisors") || []);
  supervisors.splice(index, 1);
  localStorage.setItem("supervisors", JSON.stringify(supervisors));
  renderSupervisorsList();
}

function renderSupervisorsList() {
  const tbody = document.getElementById("supervisors-list");
  tbody.innerHTML = "";
  
  const supervisors = JSON.parse(localStorage.getItem("supervisors") || "[]");
  supervisors.forEach((name, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${name}</td>
      <td><button class="btn btn-danger" onclick="deleteSupervisor(${index})">๐๏ธ ุญุฐู</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== ุฏูุงู ุดุงุดุฉ ุงูุฃููุงุฏ ุงูุซุงุจุชุฉ =====
function addFixedCode() {
  const code = document.getElementById("fixed-code-input").value.trim();
  if (!code) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุฏ");
    return;
  }
  
  if (fixedCodes.includes(code)) {
    alert("ูุฐุง ุงูููุฏ ููุฌูุฏ ุจุงููุนู");
    return;
  }
  
  fixedCodes.push(code);
  renderFixedCodesList();
  document.getElementById("fixed-code-input").value = "";
}

function deleteFixedCode(index) {
  fixedCodes.splice(index, 1);
  renderFixedCodesList();
}

function renderFixedCodesList() {
  const tbody = document.getElementById("fixed-codes-list");
  tbody.innerHTML = "";
  
  fixedCodes.forEach((code, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${code}</td>
      <td><button class="btn btn-danger" onclick="deleteFixedCode(${index})">๐๏ธ ุญุฐู</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== ุฏูุงู ูุณู ุงูุชูุงุฑูุฑ =====
function generateReports() {
  const reportsContainer = document.getElementById("reports-container");
  reportsContainer.innerHTML = "";
  
  // ุชูุฑูุฑ ุงูุฃุตูุงู
  const productsReport = document.createElement("div");
  productsReport.className = "report-card";
  productsReport.innerHTML = `
    <h3>ุชูุฑูุฑ ุงูุฃุตูุงู</h3>
    <p><strong>ุนุฏุฏ ุงูุฃุตูุงู:</strong> ${products.length}</p>
    <p><strong>ุนุฏุฏ ุงููุฌููุนุงุช:</strong> ${groups.length}</p>
  `;
  reportsContainer.appendChild(productsReport);
  
  // ุชูุฑูุฑ ุงููุฎุฒูู
  const inventoryReport = document.createElement("div");
  inventoryReport.className = "report-card";
  
  const totalQuantity = inventory.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
  const lowStock = inventory.filter(item => (parseFloat(item.quantity) || 0) < 10).length;
  
  inventoryReport.innerHTML = `
    <h3>ุชูุฑูุฑ ุงููุฎุฒูู</h3>
    <p><strong>ุฅุฌูุงูู ุงููููุฉ:</strong> ${totalQuantity}</p>
    <p><strong>ุนุฏุฏ ุงูุฃุตูุงู ููุฎูุถุฉ ุงููุฎุฒูู (&lt; 10):</strong> ${lowStock}</p>
  `;
  reportsContainer.appendChild(inventoryReport);
  
  // ุชูุฑูุฑ ุงูุชุฌููุน
  const assemblyReport = document.createElement("div");
  assemblyReport.className = "report-card";
  assemblyReport.innerHTML = `
    <h3>ุชูุฑูุฑ ุงูุชุฌููุน</h3>
    <p><strong>ุนุฏุฏ ุณุฌูุงุช ุงูุชุฌููุน:</strong> ${entries.length}</p>
    <p><strong>ุขุฎุฑ ุชุญุฏูุซ:</strong> ${localStorage.getItem("lastUpdate") || "ุบูุฑ ูุนุฑูู"}</p>
  `;
  reportsContainer.appendChild(assemblyReport);
  
  // ุชูุฑูุฑ ุงูุชุณุฌูู ุงููููู
  const dailyReport = document.createElement("div");
  dailyReport.className = "report-card";
  dailyReport.innerHTML = `
    <h3>ุชูุฑูุฑ ุงูุชุณุฌูู ุงููููู</h3>
    <p><strong>ุนุฏุฏ ุงูุณุฌูุงุช:</strong> ${dailyEntries.length}</p>
    <p><strong>ุขุฎุฑ ุชุญุฏูุซ:</strong> ${localStorage.getItem("dailyLastUpdate") || "ุบูุฑ ูุนุฑูู"}</p>
  `;
  reportsContainer.appendChild(dailyReport);
}

function exportReports() {
  const reports = [
    ["ููุน ุงูุชูุฑูุฑ", "ุงููุนูููุงุช", "ุงููููุฉ"],
    ["ุงูุฃุตูุงู", "ุนุฏุฏ ุงูุฃุตูุงู", products.length],
    ["ุงูุฃุตูุงู", "ุนุฏุฏ ุงููุฌููุนุงุช", groups.length],
    ["ุงููุฎุฒูู", "ุฅุฌูุงูู ุงููููุฉ", inventory.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0)],
    ["ุงููุฎุฒูู", "ุฃุตูุงู ููุฎูุถุฉ ุงููุฎุฒูู", inventory.filter(item => (parseFloat(item.quantity) || 0) < 10).length],
    ["ุงูุชุฌููุน", "ุนุฏุฏ ุงูุณุฌูุงุช", entries.length],
    ["ุงูุชุฌููุน", "ุขุฎุฑ ุชุญุฏูุซ", localStorage.getItem("lastUpdate") || "ุบูุฑ ูุนุฑูู"],
    ["ุงูุชุณุฌูู ุงููููู", "ุนุฏุฏ ุงูุณุฌูุงุช", dailyEntries.length],
    ["ุงูุชุณุฌูู ุงููููู", "ุขุฎุฑ ุชุญุฏูุซ", localStorage.getItem("dailyLastUpdate") || "ุบูุฑ ูุนุฑูู"]
  ];
  
  const csvContent = reports.map(row => row.join(",")).join("\n");
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ุชูุงุฑูุฑ_ุงููุธุงู_${new Date().toLocaleDateString("ar-EG")}.csv`;
  a.click();
}

// ===== ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ =====
function backupData() {
  const backup = {
    products,
    groups,
    lines,
    inventory,
    entries,
    dailyEntries,
    fixedCodes,
    supervisors: JSON.parse(localStorage.getItem("supervisors") || []),
    users,
    lastUpdate: localStorage.getItem("lastUpdate"),
    dailyLastUpdate: localStorage.getItem("dailyLastUpdate")
  };
  
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ูุณุฎุฉ_ุงุญุชูุงุทูุฉ_${new Date().toLocaleDateString("ar-EG")}.json`;
  a.click();
}

function restoreData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ.")) {
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      
      // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
      products = backup.products || [];
      groups = backup.groups || [];
      lines = backup.lines || [];
      inventory = backup.inventory || [];
      entries = backup.entries || [];
      dailyEntries = backup.dailyEntries || [];
      fixedCodes = backup.fixedCodes || ["FC-001", "FC-002", "FC-003", "FC-004"];
      
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("groups", JSON.stringify(groups));
      localStorage.setItem("lines", JSON.stringify(lines));
      localStorage.setItem("inventory", JSON.stringify(inventory));
      localStorage.setItem("batteryData", JSON.stringify(entries));
      localStorage.setItem("dailyData", JSON.stringify(dailyEntries));
      localStorage.setItem("supervisors", JSON.stringify(backup.supervisors || []));
      localStorage.setItem("erpUsers", JSON.stringify(backup.users || users));
      localStorage.setItem("lastUpdate", backup.lastUpdate || new Date().toLocaleString("ar-EG"));
      localStorage.setItem("dailyLastUpdate", backup.dailyLastUpdate || new Date().toLocaleString("ar-EG"));
      
      // ุชุญุฏูุซ ุงููุงุฌูุฉ
      initPage();
      alert("ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ");
    } catch (error) {
      alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: " + error.message);
    }
  };
  reader.readAsText(file);
}

// ===== ุฏูุงู ุนุงูุฉ =====
function showSection(sectionId) {
  // ุฅุฎูุงุก ูู ุงูุฃูุณุงู
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  
  // ุฅูุบุงุก ุชูุดูุท ูู ุฃุฒุฑุงุฑ ุงูุชุจููุจ
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // ุฅุธูุงุฑ ุงููุณู ุงููุทููุจ
  document.getElementById(sectionId).classList.add('active');
  
  // ุชูุดูุท ุฒุฑ ุงูุชุจููุจ ุงููุญุฏุฏ
  event.target.classList.add('active');
}

// ุชููุฆุฉ ุงูุตูุญุฉ ุนูุฏ ุงูุชุญููู
function initPage() {
  if (currentUser) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-sections').style.display = 'block';
    document.getElementById('user-info').textContent = `ูุฑุญุจุงู ${currentUser.name}`;
  } else {
    showLoginForm();
  }

  createExcelTable();
  renderGroupsTable();
  renderLinesTable();
  updateGroupsDropdown();
  renderProductsTable();
  renderInventoryTable();
  updateAutoCode();
  createDailyTable();
  renderSupervisorsList();
  renderFixedCodesList();
  
  // ุชุญููู ุจูุงูุงุช ุงูุชุณุฌูู ุงููููู ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
  if (!localStorage.getItem("dailyData")) {
    localStorage.setItem("dailyData", "[]");
  }
  
  // ุชุญููู ุงููุดุฑููู ุฅุฐุง ูู ูููููุง ููุฌูุฏูู
  if (!localStorage.getItem("supervisors")) {
    localStorage.setItem("supervisors", "[]");
  }
  
  // ุฅุฎูุงุก ุจุนุถ ุงูุฃุฒุฑุงุฑ ุญุณุจ ุงูุตูุงุญูุงุช
  if (currentUser && currentUser.role !== 'admin') {
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = 'none';
    });
  }
  
  // ุฑุจุท ุญุฏุซ ุงูุจุญุซ ุนูุฏ ุงูุถุบุท ุนูู Enter
  document.getElementById('product-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchProducts();
    }
  });

  document.getElementById('inventory-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchInventory();
    }
  });

  document.getElementById('group-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchGroups();
    }
  });

  document.getElementById('line-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchLines();
    }
  });

  document.getElementById('data-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      filterData();
    }
  });

  document.getElementById('daily-data-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      filterDailyData();
    }
  });
}

// ุจุฏุก ุงูุชุทุจูู
document.addEventListener('DOMContentLoaded', function() {
  initPage();
});
</script>
</body>
</html>